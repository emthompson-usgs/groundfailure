
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gfail.logisticmodel &#8212; groundfailure 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gfail.logisticmodel</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains functions and class definitions for running forward</span>
<span class="sd">models of models based on logistic regression.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># stdlib imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="c1"># from scipy import sparse</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="k">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="c1"># third party imports</span>
<span class="kn">from</span> <span class="nn">mapio.shake</span> <span class="k">import</span> <span class="n">ShakeGrid</span>
<span class="kn">from</span> <span class="nn">mapio.shake</span> <span class="k">import</span> <span class="n">getHeaderData</span>
<span class="kn">from</span> <span class="nn">mapio.gmt</span> <span class="k">import</span> <span class="n">GMTGrid</span>
<span class="kn">from</span> <span class="nn">mapio.gdal</span> <span class="k">import</span> <span class="n">GDALGrid</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="k">import</span> <span class="n">Grid2D</span>
<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="k">import</span> <span class="n">GeoDict</span>

<span class="kn">from</span> <span class="nn">gfail.temphdf</span> <span class="k">import</span> <span class="n">TempHdf</span>
<span class="kn">from</span> <span class="nn">gfail.spatial</span> <span class="k">import</span> <span class="n">quickcut</span><span class="p">,</span> <span class="n">trim_ocean</span>

<span class="c1"># temporary until mapio is updated</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>


<span class="n">PARAM_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;b[0-9]+&#39;</span>
<span class="n">LAYER_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;_layer&#39;</span>
<span class="n">TERM_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;term&#39;</span>

<span class="n">SM_TERMS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MW&#39;</span><span class="p">,</span> <span class="s1">&#39;YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="s1">&#39;HOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;pga&#39;</span><span class="p">,</span> <span class="s1">&#39;pgv&#39;</span><span class="p">,</span> <span class="s1">&#39;mmi&#39;</span><span class="p">]</span>
<span class="n">SM_GRID_TERMS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pga&#39;</span><span class="p">,</span> <span class="s1">&#39;pgv&#39;</span><span class="p">,</span> <span class="s1">&#39;mmi&#39;</span><span class="p">]</span>
<span class="c1"># these will get np. prepended</span>
<span class="n">OPERATORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;log10&#39;</span><span class="p">,</span> <span class="s1">&#39;arctan&#39;</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum&#39;</span><span class="p">,</span> <span class="s1">&#39;pi&#39;</span><span class="p">]</span>
<span class="n">FLOATPAT</span> <span class="o">=</span> <span class="s1">&#39;[+-]?(?=\d*[.eE])(?=\.?\d)\d*\.?\d*(?:[eE][+-]?\d+)?&#39;</span>
<span class="n">INTPAT</span> <span class="o">=</span> <span class="s1">&#39;[0-9]+&#39;</span>
<span class="n">OPERATORPAT</span> <span class="o">=</span> <span class="s1">&#39;[\+\-\*\/]*&#39;</span>
<span class="n">MONTHS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="LogisticModel"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.LogisticModel">[docs]</a><span class="k">class</span> <span class="nc">LogisticModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shakefile</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">uncertfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saveinputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">slopefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numstd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">slopemod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">trimfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the logistic model</span>

<span class="sd">        Args:</span>
<span class="sd">            shakefile (str): Path to shakemap grid.xml file for the event.</span>
<span class="sd">            config: configobj object defining the model and its inputs. Only</span>
<span class="sd">                one model should be described in each config file.</span>
<span class="sd">            uncertfile (str): Path to uncertainty.xml file.</span>
<span class="sd">            saveinputs (bool): Save input layers as Grid2D objects in addition</span>
<span class="sd">                to the model? If false (the default), it will just output the</span>
<span class="sd">                model.</span>
<span class="sd">            slopefile (str): Optional path to slopefile that will be resampled</span>
<span class="sd">                to the other input files for applying thresholds. OVERWRITES</span>
<span class="sd">                VALUE IN CONFIG.</span>
<span class="sd">            bounds (dict): Default of None uses ShakeMap boundaries, otherwise</span>
<span class="sd">                a dictionary of boundaries to cut to like</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    bounds = {</span>
<span class="sd">                        &#39;xmin&#39;: lonmin, &#39;xmax&#39;: lonmax,</span>
<span class="sd">                        &#39;ymin&#39;: latmin, &#39;ymax&#39;: latmax</span>
<span class="sd">                    }</span>

<span class="sd">            numstd (float): Number of +/- standard deviations to use if</span>
<span class="sd">                uncertainty is computed.</span>
<span class="sd">            slopemod (str): How slope input should be modified to be in</span>
<span class="sd">                degrees: e.g., ``np.arctan(slope) * 180. / np.pi`` or</span>
<span class="sd">                ``slope/100.`` (note that this may be in the config file</span>
<span class="sd">                already).</span>
<span class="sd">            trimfile (str): shapefile of earth&#39;s landmasses to use to cut</span>
<span class="sd">                offshore areas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mnames</span> <span class="o">=</span> <span class="n">getLogisticModelNames</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No config file found or problem with config &#39;</span>
                            <span class="s1">&#39;file format&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Config file contains more than one model which &#39;</span>
                            <span class="s1">&#39;is no longer allowed, update your config file &#39;</span>
                            <span class="s1">&#39;to the newer format&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">mnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">cmodel</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeltype</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;gfetype&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span> <span class="o">=</span> <span class="n">validateCoefficients</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)</span>
        <span class="c1"># key = layer name, value = file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">validateLayers</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">,</span> <span class="n">timeField</span> <span class="o">=</span> <span class="n">validateTerms</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span> <span class="o">=</span> <span class="n">validateInterpolations</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">validateUnits</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmused</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="s1">&#39;pga&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;pgv&#39;</span> <span class="ow">in</span>
                       <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;mmi&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelrefs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrefs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortrefs</span> <span class="o">=</span> <span class="n">validateRefs</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numstd</span> <span class="o">=</span> <span class="n">numstd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clips</span> <span class="o">=</span> <span class="n">validateClips</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmused</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;baselayer&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;You must specify a base layer corresponding to &#39;</span>
                            <span class="s1">&#39;one of the files in the layer section.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveinputs</span> <span class="o">=</span> <span class="n">saveinputs</span>
        <span class="k">if</span> <span class="n">slopefile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;slopefile&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># print(&#39;Slopefile not specified in config, no slope &#39;</span>
                <span class="c1">#      &#39;thresholds will be applied\n&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span> <span class="o">=</span> <span class="n">slopefile</span>
        <span class="k">if</span> <span class="n">slopemod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;slopemod&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># See if trimfile exists</span>
        <span class="k">if</span> <span class="n">trimfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">trimfile</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;trimfile defined does not exist: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Ocean will not be trimmed&#39;</span> <span class="o">%</span> <span class="n">trimfile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">trimfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.shp&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trimfile must be a shapefile, ocean will not be trimmed&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="o">=</span> <span class="n">trimfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get month of event</span>
        <span class="n">griddict</span><span class="p">,</span> <span class="n">eventdict</span><span class="p">,</span> <span class="n">specdict</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">uncertainties</span> <span class="o">=</span> \
            <span class="n">getHeaderData</span><span class="p">(</span><span class="n">shakefile</span><span class="p">)</span>
        <span class="n">MONTH</span> <span class="o">=</span> <span class="n">MONTHS</span><span class="p">[(</span><span class="n">eventdict</span><span class="p">[</span><span class="s1">&#39;event_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Figure out how/if need to cut anything</span>
        <span class="n">geodict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Make sure bounds are within ShakeMap Grid</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">geodict</span><span class="o">.</span><span class="n">xmin</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="ow">or</span>
                    <span class="n">geodict</span><span class="o">.</span><span class="n">xmax</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="ow">or</span>
                    <span class="n">geodict</span><span class="o">.</span><span class="n">ymin</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="ow">or</span>
                    <span class="n">geodict</span><span class="o">.</span><span class="n">ymax</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Specified bounds are outside shakemap area, using &#39;</span>
                      <span class="s1">&#39;ShakeMap bounds instead.&#39;</span><span class="p">)</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempgdict</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="o">.</span><span class="n">createDictFromBox</span><span class="p">(</span>
                <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span>
                <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">],</span>
                <span class="n">geodict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">geodict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="n">geodict</span><span class="o">.</span><span class="n">getBoundsWithin</span><span class="p">(</span><span class="n">tempgdict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="n">geodict</span>

        <span class="c1"># Now find the layer that is our base layer and get the largest bounds</span>
        <span class="c1"># we can guarantee not to exceed shakemap bounds</span>
        <span class="n">basefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;baselayer&#39;</span><span class="p">]]</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="n">getFileType</span><span class="p">(</span><span class="n">basefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;esri&#39;</span><span class="p">:</span>
            <span class="n">basegeodict</span><span class="p">,</span> <span class="n">firstcol</span> <span class="o">=</span> <span class="n">GDALGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">basefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">basegeodict</span> <span class="o">==</span> <span class="n">gdict</span><span class="p">:</span>
                <span class="n">sampledict</span> <span class="o">=</span> <span class="n">gdict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sampledict</span> <span class="o">=</span> <span class="n">basegeodict</span><span class="o">.</span><span class="n">getBoundsWithin</span><span class="p">(</span><span class="n">gdict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;gmt&#39;</span><span class="p">:</span>
            <span class="n">basegeodict</span><span class="p">,</span> <span class="n">firstcol</span> <span class="o">=</span> <span class="n">GMTGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">basefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">basegeodict</span> <span class="o">==</span> <span class="n">gdict</span><span class="p">:</span>
                <span class="n">sampledict</span> <span class="o">=</span> <span class="n">gdict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sampledict</span> <span class="o">=</span> <span class="n">basegeodict</span><span class="o">.</span><span class="n">getBoundsWithin</span><span class="p">(</span><span class="n">gdict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;All predictor variable grids must be a valid &#39;</span>
                            <span class="s1">&#39;GMT or ESRI file type.&#39;</span><span class="p">)</span>

        <span class="c1"># Do we need to subdivide baselayer?</span>
        <span class="k">if</span> <span class="s1">&#39;divfactor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">divfactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;divfactor&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">divfactor</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="c1"># adjust sampledict so everything will be resampled</span>
                <span class="n">newxmin</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> \
                    <span class="mf">2.</span> <span class="o">+</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">divfactor</span><span class="p">)</span>
                <span class="n">newymin</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> \
                    <span class="mf">2.</span> <span class="o">+</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dy</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">divfactor</span><span class="p">)</span>
                <span class="n">newxmax</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">xmax</span> <span class="o">+</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> \
                    <span class="mf">2.</span> <span class="o">-</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">divfactor</span><span class="p">)</span>
                <span class="n">newymax</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">ymax</span> <span class="o">+</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> \
                    <span class="mf">2.</span> <span class="o">-</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dy</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">divfactor</span><span class="p">)</span>
                <span class="n">newdx</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="n">divfactor</span>
                <span class="n">newdy</span> <span class="o">=</span> <span class="n">sampledict</span><span class="o">.</span><span class="n">dy</span><span class="o">/</span><span class="n">divfactor</span>

                <span class="n">sampledict</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="o">.</span><span class="n">createDictFromBox</span><span class="p">(</span>
                    <span class="n">newxmin</span><span class="p">,</span> <span class="n">newxmax</span><span class="p">,</span> <span class="n">newymin</span><span class="p">,</span>
                    <span class="n">newymax</span><span class="p">,</span> <span class="n">newdx</span><span class="p">,</span> <span class="n">newdy</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Find slope thresholds, if applicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">if</span> <span class="n">slopefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;slopemin&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;slopemax&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not find slopemin and/or slopemax in config, &#39;</span>
                      <span class="s1">&#39;limits. No slope thresholds will be applied.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="c1"># Make temporary directory for hdf5 pytables file storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="c1"># now load the shakemap, resampling and padding if necessary</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">)</span>  <span class="c1"># , adjust=&#39;res&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shakedict</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getShakeDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventdict</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getEventDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Read both PGA and PGV in, may need them for thresholds</span>
        <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pga&#39;</span><span class="p">,</span> <span class="s1">&#39;pgv&#39;</span><span class="p">]:</span>
            <span class="n">junkfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;temp.bil&#39;</span><span class="p">)</span>
            <span class="n">GDALGrid</span><span class="o">.</span><span class="n">copyFromGrid</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">gm</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">junkfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">intermeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="p">[</span><span class="n">gm</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intermeth</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
            <span class="n">junkgrid</span> <span class="o">=</span> <span class="n">quickcut</span><span class="p">(</span><span class="n">junkfile</span><span class="p">,</span> <span class="n">sampledict</span><span class="p">,</span> <span class="n">precise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">method</span><span class="o">=</span><span class="n">intermeth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">:</span>
                <span class="n">junkgrid</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">junkgrid</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">gm</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">gm</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="n">gm</span><span class="p">]</span> <span class="o">=</span> <span class="n">TempHdf</span><span class="p">(</span>
                <span class="n">junkgrid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">gm</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">junkfile</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="c1"># get updated geodict</span>
        <span class="n">sampledict</span> <span class="o">=</span> <span class="n">junkgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>

        <span class="c1"># take uncertainties into account, if available</span>
        <span class="k">if</span> <span class="n">uncertfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Only read in the ones that will be needed</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">uncertfile</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmused</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;pgv&#39;</span> <span class="ow">in</span> <span class="n">gm</span><span class="p">:</span>
                        <span class="n">gmsimp</span> <span class="o">=</span> <span class="s1">&#39;pgv&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;pga&#39;</span> <span class="ow">in</span> <span class="n">gm</span><span class="p">:</span>
                        <span class="n">gmsimp</span> <span class="o">=</span> <span class="s1">&#39;pga&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;mmi&#39;</span> <span class="ow">in</span> <span class="n">gm</span><span class="p">:</span>
                        <span class="n">gmsimp</span> <span class="o">=</span> <span class="s1">&#39;mmi&#39;</span>
                    <span class="n">junkfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;temp.bil&#39;</span><span class="p">)</span>
                    <span class="n">GDALGrid</span><span class="o">.</span><span class="n">copyFromGrid</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span>
                        <span class="s1">&#39;std</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gmsimp</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">junkfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">gmsimp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">intermeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="p">[</span><span class="n">gmsimp</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intermeth</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
                    <span class="n">junkgrid</span> <span class="o">=</span> <span class="n">quickcut</span><span class="p">(</span><span class="n">junkfile</span><span class="p">,</span> <span class="n">sampledict</span><span class="p">,</span> <span class="n">precise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="n">intermeth</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">gmsimp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">:</span>
                        <span class="n">junkgrid</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">junkgrid</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">gmsimp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">gmsimp</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span><span class="p">[</span><span class="s1">&#39;std&#39;</span> <span class="o">+</span> <span class="n">gmsimp</span><span class="p">]</span> <span class="o">=</span> <span class="n">TempHdf</span><span class="p">(</span>
                        <span class="n">junkgrid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span>
                                               <span class="s1">&#39;std</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">gmsimp</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">junkfile</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not read uncertainty file, ignoring &#39;</span>
                      <span class="s1">&#39;uncertainties&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Load the predictor layers, save as hdf5 temporary files, put file</span>
        <span class="c1"># locations into a dictionary.</span>

        <span class="c1"># Will be replaced in the next section if a slopefile was defined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># key = layer name, value = grid object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">didslope</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">layername</span><span class="p">,</span> <span class="n">layerfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layerfile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">lfile</span> <span class="ow">in</span> <span class="n">layerfile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timeField</span> <span class="o">==</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lfile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">MONTH</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">layerfile</span> <span class="o">=</span> <span class="n">lfile</span>
                            <span class="n">ftype</span> <span class="o">=</span> <span class="n">getFileType</span><span class="p">(</span><span class="n">layerfile</span><span class="p">)</span>
                            <span class="n">interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="n">quickcut</span><span class="p">(</span><span class="n">layerfile</span><span class="p">,</span> <span class="n">sampledict</span><span class="p">,</span>
                                            <span class="n">precise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">layername</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">:</span>
                                <span class="n">temp</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span> <span class="o">=</span> <span class="n">TempHdf</span><span class="p">(</span>
                                <span class="n">temp</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span>
                                                   <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">layername</span><span class="p">))</span>
                            <span class="k">del</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolations</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">quickcut</span><span class="p">(</span><span class="n">layerfile</span><span class="p">,</span> <span class="n">sampledict</span><span class="p">,</span>
                                <span class="n">precise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">layername</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">:</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span> <span class="o">=</span> <span class="n">TempHdf</span><span class="p">(</span>
                    <span class="n">temp</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">layername</span><span class="p">))</span>
                <span class="n">td</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">td</span> <span class="o">!=</span> <span class="n">sampledict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s1">&#39;Geodictionaries of resampled files do not match&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">layerfile</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">slope1</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">slope</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">slope</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                            <span class="n">slope1</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;slopemod provided not valid, continuing &#39;</span>
                                  <span class="s1">&#39;without slope thresholds.&#39;</span><span class="p">)</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[(</span><span class="n">slope1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">slope1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span><span class="p">)])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Still remove areas where the slope equals exactly</span>
                        <span class="c1"># 0.0 to remove offshore liq areas.</span>
                        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slope1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span>
                    <span class="n">didslope</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">%s</span><span class="s1"> layer: </span><span class="si">%1.1f</span><span class="s1"> sec&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">layername</span><span class="p">,</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">didslope</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Slope didn&#39;t get read in yet</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">quickcut</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span><span class="p">,</span> <span class="n">sampledict</span><span class="p">,</span> <span class="n">precise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">slope1</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">slope</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">slope1</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slopemod</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;slopemod provided not valid, continuing without &#39;</span>
                          <span class="s1">&#39;slope thresholds&#39;</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">slope1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span><span class="p">)</span> <span class="o">&amp;</span>
                                    <span class="p">(</span><span class="n">slope1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">del</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Still remove areas where the slope equals exactly</span>
                <span class="c1"># 0.0 to remove offshore liq areas.</span>
                <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slope1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">del</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">])]</span>

        <span class="n">ckeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ckeys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ckeys</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%g</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nugmin</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nugmax</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span><span class="p">)</span>

            <span class="c1"># Find the term with the shakemap input and replace for these</span>
            <span class="c1"># nuggets.</span>
            <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pga&#39;</span><span class="p">,</span> <span class="s1">&#39;mmi&#39;</span><span class="p">,</span> <span class="s1">&#39;pgv&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nug</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuggets</span><span class="p">):</span>
                    <span class="n">tempnug</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;self.shakemap[&#39;</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, &quot;</span>
                               <span class="s2">&quot;rowend, colstart, colend, name=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">gm</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">tempnug</span> <span class="ow">in</span> <span class="n">nug</span><span class="p">:</span>
                        <span class="n">newnug</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;np.exp(np.log(</span><span class="si">%s</span><span class="s2">) - self.numstd * &quot;</span>
                                  <span class="s2">&quot;self.uncert[&#39;std</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, &quot;</span>
                                  <span class="s2">&quot;rowend, colstart, colend, name=&#39;std</span><span class="si">%s</span><span class="s2">&#39;))&quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">tempnug</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="n">gm</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nugmin</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugmin</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">tempnug</span><span class="p">,</span> <span class="n">newnug</span><span class="p">)</span>
                        <span class="n">newnug</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;np.exp(np.log(</span><span class="si">%s</span><span class="s2">) + self.numstd * &quot;</span>
                                  <span class="s2">&quot;self.uncert[&#39;std</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, &quot;</span>
                                  <span class="s2">&quot;rowend, colstart, colend, name=&#39;std</span><span class="si">%s</span><span class="s2">&#39;))&quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">tempnug</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="n">gm</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nugmax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugmax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">tempnug</span><span class="p">,</span> <span class="n">newnug</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">equationmin</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nugmin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equationmax</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nugmax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equationmin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equationmax</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span> <span class="o">=</span> <span class="n">sampledict</span>

<div class="viewcode-block" id="LogisticModel.getEquations"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.LogisticModel.getEquations">[docs]</a>    <span class="k">def</span> <span class="nf">getEquations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for LogisticModel class to extract strings defining the</span>
<span class="sd">        equations for the model for median ground motions and +/- one standard</span>
<span class="sd">        deviation (3 total).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (equation, equationmin, equationmax) where:</span>
<span class="sd">                * equation: the equation for median ground motions,</span>
<span class="sd">                * equationmin: the equation for the same model but using</span>
<span class="sd">                  median ground motions minus 1 standard deviation</span>
<span class="sd">                * equationmax: same as above but for plus 1 standard deviation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equationmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equationmax</span></div>

<div class="viewcode-block" id="LogisticModel.getGeoDict"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.LogisticModel.getGeoDict">[docs]</a>    <span class="k">def</span> <span class="nf">getGeoDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the geodictionary of the LogisticModel class defining bounds</span>
<span class="sd">        and resolution of model inputs and outputs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            geodict: mapio geodict object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span></div>

<div class="viewcode-block" id="LogisticModel.calculate"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.LogisticModel.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rowmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">colmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            cleanup (bool): If True, delete temporary hdf5 files</span>
<span class="sd">            rowmax (int): Number of rows to compute at once; If None, all rows</span>
<span class="sd">                will be computed at once.</span>
<span class="sd">            colmax (int): Number of columns to compute at once; If None, all</span>
<span class="sd">                columns will be computed at once.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing the model results (and model inputs if</span>
<span class="sd">            saveinputs was set to True). See</span>
<span class="sd">            `the description &lt;https://github.com/usgs/groundfailure#api-for-model-output&gt;`_</span>
<span class="sd">            of the structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Figure out what slices to do</span>
        <span class="n">rowstarts</span><span class="p">,</span> <span class="n">rowends</span><span class="p">,</span> <span class="n">colstarts</span><span class="p">,</span> <span class="n">colends</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span><span class="o">.</span><span class="n">getSliceDiv</span><span class="p">(</span><span class="n">rowmax</span><span class="p">,</span> <span class="n">colmax</span><span class="p">)</span>

        <span class="c1"># Make empty matrix to fill</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="o">.</span><span class="n">nx</span><span class="p">])</span>

        <span class="c1"># Loop through slices, appending output each time</span>
        <span class="k">for</span> <span class="n">rowstart</span><span class="p">,</span> <span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">,</span> <span class="n">colend</span> <span class="ow">in</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="n">rowstarts</span><span class="p">,</span> <span class="n">rowends</span><span class="p">,</span> <span class="n">colstarts</span><span class="p">,</span> <span class="n">colends</span><span class="p">):</span>
            <span class="n">X</span><span class="p">[</span><span class="n">rowstart</span><span class="p">:</span><span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">:</span><span class="n">colend</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="p">)</span>

        <span class="n">P</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;vs30max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">vs30</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span><span class="p">[</span><span class="s1">&#39;vs30&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vs30&#39;</span><span class="p">)</span>
            <span class="n">P</span><span class="p">[</span><span class="n">vs30</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;vs30max&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="s1">&#39;minpgv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pgv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pgv&#39;</span><span class="p">)</span>
            <span class="n">P</span><span class="p">[</span><span class="n">pgv</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpgv&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="s1">&#39;minpga&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pga</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="s1">&#39;pga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pga&#39;</span><span class="p">)</span>
            <span class="n">P</span><span class="p">[</span><span class="n">pga</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpga&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="s1">&#39;coverage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">eqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;coverage&#39;</span><span class="p">][</span><span class="s1">&#39;eqn&#39;</span><span class="p">]</span>
            <span class="n">P</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">eqn</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make empty matrix to fill</span>
            <span class="n">Xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="o">.</span><span class="n">nx</span><span class="p">])</span>
            <span class="n">Xmax</span> <span class="o">=</span> <span class="n">Xmin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Loop through slices, appending output each time</span>
            <span class="k">for</span> <span class="n">rowstart</span><span class="p">,</span> <span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">,</span> <span class="n">colend</span> <span class="ow">in</span> \
                    <span class="nb">zip</span><span class="p">(</span><span class="n">rowstarts</span><span class="p">,</span> <span class="n">rowends</span><span class="p">,</span> <span class="n">colstarts</span><span class="p">,</span> <span class="n">colends</span><span class="p">):</span>
                <span class="n">Xmin</span><span class="p">[</span><span class="n">rowstart</span><span class="p">:</span><span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">:</span><span class="n">colend</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equationmin</span><span class="p">)</span>
                <span class="n">Xmax</span><span class="p">[</span><span class="n">rowstart</span><span class="p">:</span><span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">:</span><span class="n">colend</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equationmax</span><span class="p">)</span>

            <span class="n">Pmin</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Xmin</span><span class="p">))</span>
            <span class="n">Pmax</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Xmax</span><span class="p">))</span>

            <span class="k">if</span> <span class="s1">&#39;vs30max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vs30</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span><span class="p">[</span><span class="s1">&#39;vs30&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vs30&#39;</span><span class="p">)</span>
                <span class="n">Pmin</span><span class="p">[</span><span class="n">vs30</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;vs30max&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Pmax</span><span class="p">[</span><span class="n">vs30</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;vs30max&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="s1">&#39;minpgv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pgv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pgv&#39;</span><span class="p">)</span>
                <span class="n">Pmin</span><span class="p">[</span><span class="n">pgv</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpgv&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Pmax</span><span class="p">[</span><span class="n">pgv</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpgv&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="s1">&#39;minpga&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pga</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pga&#39;</span><span class="p">)</span>
                <span class="n">Pmin</span><span class="p">[</span><span class="n">pga</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpga&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Pmax</span><span class="p">[</span><span class="n">pga</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpga&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="s1">&#39;coverage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">eqnmin</span> <span class="o">=</span> <span class="n">eqn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pmin&#39;</span><span class="p">)</span>
                <span class="n">eqnmax</span> <span class="o">=</span> <span class="n">eqn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pmax&#39;</span><span class="p">)</span>
                <span class="n">Pmin</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">eqnmin</span><span class="p">)</span>
                <span class="n">Pmax</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">eqnmax</span><span class="p">)</span>

            <span class="c1">#Pmin[np.isnan(Pmin)] = 0.0</span>
            <span class="c1">#Pmax[np.isnan(Pmax)] = 0.0</span>

        <span class="c1">#P[np.isnan(P)] = 0.0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Apply slope min/max limits</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying slope thresholds&#39;</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>
            <span class="c1">#P[P==0.0] = float(&#39;nan&#39;)</span>
            <span class="c1">#P[np.isnan(P)] = 0.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Pmin</span> <span class="o">=</span> <span class="n">Pmin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>
                <span class="n">Pmax</span> <span class="o">=</span> <span class="n">Pmax</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span>
                <span class="c1">#Pmin[Pmin==0.0] = float(&#39;nan&#39;)</span>
                <span class="c1">#Pmax[Pmax==0.0] = float(&#39;nan&#39;)</span>
                <span class="c1">#Pmin[np.isnan(Pmin)] = 0.0</span>
                <span class="c1">#Pmax[np.isnan(Pmax)] = 0.0</span>

        <span class="c1"># Stuff into Grid2D object</span>
        <span class="k">if</span> <span class="s1">&#39;Jessee&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;coverage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">units5</span> <span class="o">=</span> <span class="s1">&#39;Relative Hazard&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">units5</span> <span class="o">=</span> <span class="s1">&#39;Proportion of area affected&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;Zhu&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">]:</span>
            <span class="n">units5</span> <span class="o">=</span> <span class="s1">&#39;Proportion of area affected&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units5</span> <span class="o">=</span> <span class="s1">&#39;Probability of any occurrence&#39;</span>

        <span class="n">shakedetail</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ver</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shakedict</span><span class="p">[</span><span class="s1">&#39;shakemap_id&#39;</span><span class="p">],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">shakedict</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">]))</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">],</span>
            <span class="s1">&#39;longref&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;longref&#39;</span><span class="p">],</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units5</span><span class="p">,</span>
            <span class="s1">&#39;shakemap&#39;</span><span class="p">:</span> <span class="n">shakedetail</span><span class="p">,</span>
            <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventdict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slopemin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemin</span><span class="p">,</span>
                           <span class="s1">&#39;slopemax&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slopemax</span><span class="p">,</span>
                           <span class="s1">&#39;modeltype&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeltype</span><span class="p">}}</span>
        <span class="k">if</span> <span class="s1">&#39;vs30max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;vs30max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;vs30max&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;minpgv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;minpgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;minpgv&#39;</span><span class="p">])</span>

        <span class="n">Pgrid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Turn all offshore cells to nan</span>
            <span class="n">Pgrid</span> <span class="o">=</span> <span class="n">trim_ocean</span><span class="p">(</span><span class="n">Pgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Pgrid</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeltype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                                  <span class="n">units5</span><span class="o">.</span><span class="n">title</span><span class="p">()),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Pmingrid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">Pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">)</span>
            <span class="n">Pmaxgrid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">Pmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Pmingrid</span> <span class="o">=</span> <span class="n">trim_ocean</span><span class="p">(</span>
                    <span class="n">Pmingrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                <span class="n">Pmaxgrid</span> <span class="o">=</span> <span class="n">trim_ocean</span><span class="p">(</span>
                    <span class="n">Pmaxgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trimfile</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;modelmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Pmingrid</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> (-</span><span class="si">%0.1f</span><span class="s1"> std ground motion)&#39;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeltype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                             <span class="n">units5</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">numstd</span><span class="p">)),</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
            <span class="p">}</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;modelmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Pmaxgrid</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> (+</span><span class="si">%0.1f</span><span class="s1"> std ground motion)&#39;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeltype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                             <span class="n">units5</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">numstd</span><span class="p">)),</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
            <span class="p">}</span>

        <span class="c1"># This step might swamp memory for higher resolution runs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveinputs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layername</span><span class="p">,</span> <span class="n">layergrid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layerdict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">rdict</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Grid2D</span><span class="p">(</span>
                        <span class="n">layergrid</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">layername</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span>
                    <span class="p">),</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layername</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortrefs</span><span class="p">[</span><span class="n">layername</span><span class="p">],</span>
                        <span class="s1">&#39;longref&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrefs</span><span class="p">[</span><span class="n">layername</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">for</span> <span class="n">gmused</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmused</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;pga&#39;</span> <span class="ow">in</span> <span class="n">gmused</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>
                    <span class="n">getkey</span> <span class="o">=</span> <span class="s1">&#39;pga&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;pgv&#39;</span> <span class="ow">in</span> <span class="n">gmused</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cm/s&#39;</span>
                    <span class="n">getkey</span> <span class="o">=</span> <span class="s1">&#39;pgv&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;mmi&#39;</span> <span class="ow">in</span> <span class="n">gmused</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
                    <span class="n">getkey</span> <span class="o">=</span> <span class="s1">&#39;mmi&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                    <span class="c1"># Layer is derived from several input layers, skip</span>
                    <span class="c1"># outputting this layer</span>

                <span class="k">if</span> <span class="n">getkey</span> <span class="ow">in</span> <span class="n">rdict</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shakemap</span><span class="p">[</span><span class="n">getkey</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">getkey</span><span class="p">)</span>
                <span class="n">rdict</span><span class="p">[</span><span class="n">getkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">),</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">getkey</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">units</span><span class="p">),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                        <span class="s1">&#39;shakemap&#39;</span><span class="p">:</span> <span class="n">shakedetail</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">uncertlayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span><span class="p">[</span><span class="n">getkey</span><span class="p">]</span><span class="o">.</span><span class="n">getSlice</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="o">+</span><span class="n">getkey</span><span class="p">)</span>
                    <span class="n">layer1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">-</span> <span class="n">uncertlayer</span><span class="p">)</span>
                    <span class="n">rdict</span><span class="p">[</span><span class="n">getkey</span> <span class="o">+</span> <span class="s1">&#39;modelmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">layer1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">),</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%0.1f</span><span class="s1"> std (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">getkey</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">numstd</span><span class="p">,</span> <span class="n">units</span><span class="p">)),</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                        <span class="s1">&#39;shakemap&#39;</span><span class="p">:</span> <span class="n">shakedetail</span><span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">layer2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">+</span> <span class="n">uncertlayer</span><span class="p">)</span>
                    <span class="n">rdict</span><span class="p">[</span><span class="n">getkey</span> <span class="o">+</span> <span class="s1">&#39;modelmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">layer2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodict</span><span class="p">),</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%0.1f</span><span class="s1"> std (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">getkey</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">numstd</span><span class="p">,</span> <span class="n">units</span><span class="p">)),</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                        <span class="s1">&#39;shakemap&#39;</span><span class="p">:</span> <span class="n">shakedetail</span><span class="p">}</span>
                    <span class="p">}</span>
        <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdict</span></div></div>


<div class="viewcode-block" id="getLogisticModelNames"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.getLogisticModelNames">[docs]</a><span class="k">def</span> <span class="nf">getLogisticModelNames</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the names of the models present in the configobj</span>

<span class="sd">    Args:</span>
<span class="sd">        config: configobj object defining the model and its inputs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of model names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lmodel_space</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">lmodel_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a model</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span></div>


<div class="viewcode-block" id="getFileType"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.getFileType">[docs]</a><span class="k">def</span> <span class="nf">getFileType</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether input file is a shapefile or a grid (ESRI or GMT).</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): Path to candidate filename.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: &#39;shapefile&#39;, &#39;grid&#39;, or &#39;unknown&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO MOVE TO MAPIO.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;dir&#39;</span>
    <span class="n">ftype</span> <span class="o">=</span> <span class="n">GMTGrid</span><span class="o">.</span><span class="n">getFileType</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ftype</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;gmt&#39;</span>
    <span class="c1"># Skip over ESRI header files</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.hdr&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">GDALGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;esri&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span></div>


<div class="viewcode-block" id="getAllGridFiles"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.getAllGridFiles">[docs]</a><span class="k">def</span> <span class="nf">getAllGridFiles</span><span class="p">(</span><span class="n">indir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list of all gmt or esri (.grd, .bil) files in a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        indir (str): Directory to search.</span>
<span class="sd">    Returns:</span>
<span class="sd">        list: List of file names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO MOVE TO MAPIO</span>
    <span class="n">tflist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">indir</span><span class="p">)</span>
    <span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tflist</span><span class="p">:</span>
        <span class="n">fullfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="n">getFileType</span><span class="p">(</span><span class="n">fullfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gmt&#39;</span><span class="p">,</span> <span class="s1">&#39;esri&#39;</span><span class="p">]:</span>
            <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fullfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flist</span></div>


<div class="viewcode-block" id="validateCoefficients"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateCoefficients">[docs]</a><span class="k">def</span> <span class="nf">validateCoefficients</span><span class="p">(</span><span class="n">cmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures coefficients provided in model description are valid and outputs</span>
<span class="sd">    a dictionary of the coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model,</span>
<span class="sd">            for example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                cmodel = config[&#39;test_model&#39;]</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: a dictionary of model coefficients named b0, b1, b2...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;b[0-9]*&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;coefficients must be named b0, b1, ...&#39;</span><span class="p">)</span>
        <span class="n">coeffs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;b0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;coefficients must include an intercept &#39;</span>
                        <span class="s1">&#39;coefficient named b0.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span></div>


<div class="viewcode-block" id="validateClips"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateClips">[docs]</a><span class="k">def</span> <span class="nf">validateClips</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">gmused</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures coefficients provided in model description are valid and outputs</span>
<span class="sd">    a dictionary of the coefficients.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model,</span>
<span class="sd">            for example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                cmodel = config[&#39;test_model&#39;]</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: a dictionary of clip values for each layer (if exists)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clips</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;clip&#39;</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;clip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gmused</span><span class="p">:</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">gmused</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">par</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s1">&#39;Clipping key </span><span class="si">%s</span><span class="s1"> does not match any names of layers&#39;</span>
                            <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">clips</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">clips</span></div>


<div class="viewcode-block" id="validateLayers"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateLayers">[docs]</a><span class="k">def</span> <span class="nf">validateLayers</span><span class="p">(</span><span class="n">cmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures all input files required to run the model exist and are valid</span>
<span class="sd">    file types.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model,</span>
<span class="sd">            for example,</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                cmodel = config[&#39;test_model&#39;]</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: a dictionary of file names, e.g.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;slope&#39;: &#39;slopefile.bil&#39;,</span>
<span class="sd">                &#39;vs30&#39;: &#39;vs30.grd&#39;</span>
<span class="sd">            }</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">longrefs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">shortrefs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="n">getFileType</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;layer file </span><span class="si">%s</span><span class="s1"> is not a valid GMT or &#39;</span>
                                    <span class="s1">&#39;ESRI file.&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;dir&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">getAllGridFiles</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;shortref&#39;</span><span class="p">:</span>
                <span class="n">shortrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;longref&#39;</span><span class="p">:</span>
                <span class="n">longrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">layers</span></div>


<div class="viewcode-block" id="validateTerms"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateTerms">[docs]</a><span class="k">def</span> <span class="nf">validateTerms</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformats model inputs from config file, replacing functions with numpy</span>
<span class="sd">    functions, inserting code for extracting data from each layer (required</span>
<span class="sd">    to run eval in the calculate step), addressing any time variables, and</span>
<span class="sd">    checks that term names match coefficient names.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model,</span>
<span class="sd">            e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                cmodel = config[&#39;test_model&#39;]</span>

<span class="sd">        coeffs (dict): Dictionary of model coefficients, e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {&#39;b0&#39;: 3.5, &#39;b1&#39;: -0.01}</span>

<span class="sd">        layers (dict): Dictionary of file names for all input layers, e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {&#39;slope&#39;: &#39;slopefile.bil&#39;, &#39;vs30&#39;: &#39;vs30.grd&#39;}</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (terms, timeField), where</span>
<span class="sd">            - &#39;terms&#39; is a dictionary of terms that form the model equation,</span>
<span class="sd">              e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {</span>
<span class="sd">                    &#39;b1&#39;: &quot;self.layerdict[&#39;friction&#39;].getData()&quot;,</span>
<span class="sd">                    &#39;b2&#39;: &quot;self.layerdict[&#39;slope&#39;].getData()/100.&quot;</span>
<span class="sd">                }</span>

<span class="sd">            - &#39;timeField&#39; indicates the time that is used to know which input</span>
<span class="sd">              file to read in, e.g. for monthly average precipitation, &#39;MONTH&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO:</span>
    <span class="c1">#    - Return a time field for every term, not just one global one.</span>

    <span class="n">terms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">timeField</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Term names must match names of coefficients&#39;</span><span class="p">)</span>
        <span class="c1"># replace log with np.log, make sure variables are all in layers list,</span>
        <span class="c1"># etc.</span>
        <span class="n">term</span><span class="p">,</span> <span class="n">rem</span><span class="p">,</span> <span class="n">tTimeField</span> <span class="o">=</span> <span class="n">checkTerm</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tTimeField</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeField</span> <span class="o">=</span> <span class="n">tTimeField</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Term &quot;</span><span class="si">%s</span><span class="s1">&quot; contains the unknown text fragment &quot;</span><span class="si">%s</span><span class="s1">&quot;. &#39;</span>
                   <span class="s1">&#39;This may cause the expression to fail.&#39;</span><span class="p">)</span>
            <span class="n">tpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">tpl</span><span class="p">)</span>
        <span class="n">terms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">term</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">timeField</span><span class="p">)</span></div>


<div class="viewcode-block" id="validateInterpolations"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateInterpolations">[docs]</a><span class="k">def</span> <span class="nf">validateInterpolations</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate logistic model interpolation.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model.</span>
<span class="sd">        layers (dict): Dictionary of file names for all input layers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Model interpolation methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interpolations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;interpolations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Interpolation key </span><span class="si">%s</span><span class="s1"> does not match any names of layers&#39;</span>
                <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Interpolation method </span><span class="si">%s</span><span class="s1"> not in approved list of methods: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">methods</span><span class="p">)))</span>
        <span class="n">interpolations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">interpolations</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;No interpolation method configured for layer </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolations</span></div>


<div class="viewcode-block" id="validateUnits"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateUnits">[docs]</a><span class="k">def</span> <span class="nf">validateUnits</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate model units.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model.</span>
<span class="sd">        layers (dict): Dictionary of file names for all input layers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Model units.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No unit string configured for layer </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">units</span></div>


<div class="viewcode-block" id="validateLogisticModels"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateLogisticModels">[docs]</a><span class="k">def</span> <span class="nf">validateLogisticModels</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate model names.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model.</span>
<span class="sd">        layers (dict): Dictionary of file names for all input layers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the model names are valid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mnames</span> <span class="o">=</span> <span class="n">getLogisticModelNames</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Config file contains more than one model which is &#39;</span>
                        <span class="s1">&#39;no longer allowed, update your config file to the &#39;</span>
                        <span class="s1">&#39;newer format&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cmodelname</span> <span class="ow">in</span> <span class="n">mnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmodel</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">cmodelname</span><span class="p">]</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">validateCoefficients</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)</span>
            <span class="c1"># key = layer name, value = file name</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">validateLayers</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)</span>
            <span class="n">terms</span><span class="p">,</span> <span class="n">timeField</span> <span class="o">=</span> <span class="n">validateTerms</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timeField</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layerfile</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layerfile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">lfile</span> <span class="ow">in</span> <span class="n">layerfile</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">timeField</span> <span class="o">==</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">:</span>
                                <span class="k">pass</span>
            <span class="n">validateInterpolations</span><span class="p">(</span><span class="n">cmodel</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;baselayer&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s1">&#39;Model </span><span class="si">%s</span><span class="s1"> missing baselayer parameter.&#39;</span> <span class="o">%</span> <span class="n">cmodelname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Validation failed with error: &quot;</span><span class="si">%s</span><span class="s1">&quot; on model </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">cmodelname</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="validateRefs"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.validateRefs">[docs]</a><span class="k">def</span> <span class="nf">validateRefs</span><span class="p">(</span><span class="n">cmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate references for models and layers.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmodel (dict): Sub-dictionary from config for specific model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (modelrefs, longrefs, shortrefs) where:</span>
<span class="sd">            * modelrefs: dictionary of citation information for model</span>
<span class="sd">                keys=&#39;longref&#39;, &#39;shortref&#39;</span>
<span class="sd">            * shortrefs: dictionary containing short reference for each</span>
<span class="sd">                input layer</span>
<span class="sd">            * longrefs: dictionary containing full references for each</span>
<span class="sd">                input layer</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">longrefs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">shortrefs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">modelrefs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;longref&#39;</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">longrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;longref&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No longref provided for layer </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">longrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;shortref&#39;</span> <span class="ow">in</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">shortrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;shortref&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No shortref provided for layer </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">shortrefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;longref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;longref&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No model longref provided&#39;</span><span class="p">)</span>
        <span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;longref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmodel</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No model shortref provided&#39;</span><span class="p">)</span>
        <span class="n">modelrefs</span><span class="p">[</span><span class="s1">&#39;shortref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">return</span> <span class="n">modelrefs</span><span class="p">,</span> <span class="n">longrefs</span><span class="p">,</span> <span class="n">shortrefs</span></div>


<div class="viewcode-block" id="checkTerm"><a class="viewcode-back" href="../../gfail.logisticmodel.html#gfail.logisticmodel.checkTerm">[docs]</a><span class="k">def</span> <span class="nf">checkTerm</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks terms of equation and replaces text with machine readable operators</span>

<span class="sd">    Args:</span>
<span class="sd">        term: term from model configuration file</span>
<span class="sd">        layers: dictionary of file names for all input layers</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (term, tterm, timeField) where:</span>
<span class="sd">            * term: dictionary of verified terms for equation with keys corresponding</span>
<span class="sd">                to each layer name</span>
<span class="sd">            * tterm: any unconverted and unverified text that may cause expression to fail</span>
<span class="sd">            * timeField: if any inputs are time dependent, output is unit of time (e.g., &#39;YEAR&#39;),</span>
<span class="sd">                otherwise, None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># startterm = term</span>
    <span class="c1"># Strip out everything that isn&#39;t: 0-9.() operators, +-/* or layer names.</span>
    <span class="c1"># Anything left is an unknown symbol.</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">term</span>
    <span class="c1"># remove log, sqrt, etc.</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
        <span class="n">tterm</span> <span class="o">=</span> <span class="n">tterm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># remove ShakeMap variables</span>
    <span class="k">for</span> <span class="n">sm_term</span> <span class="ow">in</span> <span class="n">SM_TERMS</span><span class="p">:</span>
        <span class="n">tterm</span> <span class="o">=</span> <span class="n">tterm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sm_term</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># remove layer names</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="n">tterm</span> <span class="o">=</span> <span class="n">tterm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># remove arithmetic operators</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">OPERATORPAT</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tterm</span><span class="p">)</span>
    <span class="c1"># remove floating point numbers</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">FLOATPAT</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tterm</span><span class="p">)</span>
    <span class="c1"># remove integer numbers</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">INTPAT</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tterm</span><span class="p">)</span>
    <span class="c1"># remove parentheses</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[()]*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tterm</span><span class="p">)</span>
    <span class="c1"># remove any blank spaces</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">tterm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># remove commas</span>
    <span class="n">tterm</span> <span class="o">=</span> <span class="n">tterm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="c1"># anything left *might* cause an error</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;np.&#39;</span><span class="o">+</span><span class="n">op</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sm_term</span> <span class="ow">in</span> <span class="n">SM_GRID_TERMS</span><span class="p">:</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">sm_term</span><span class="p">,</span>
            <span class="s2">&quot;self.shakemap[&#39;</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, rowend, &quot;</span>
            <span class="s2">&quot;colstart, colend, name=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sm_term</span><span class="p">,</span> <span class="n">sm_term</span><span class="p">))</span>

    <span class="c1"># replace the macro MW with the magnitude value from the shakemap</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MW&#39;</span><span class="p">,</span> <span class="s2">&quot;self.eventdict[&#39;magnitude&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># term.replace(&#39;YEAR&#39;,&quot;self.shakemap.getEventDict()[&#39;event_time&#39;].year&quot;)</span>
    <span class="c1"># hasTime = False</span>
    <span class="n">timeField</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="s1">&#39;HOUR&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">timeField</span> <span class="o">=</span> <span class="n">unit</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s1">&#39;friction&#39;</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">layer</span><span class="p">,</span>
                <span class="s2">&quot;np.nan_to_num(self.layerdict[&#39;</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, &quot;</span>
                <span class="s2">&quot;rowend, colstart, colend, name=&#39;</span><span class="si">%s</span><span class="s2">&#39;))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">layer</span><span class="p">,</span>
                <span class="s2">&quot;self.layerdict[&#39;</span><span class="si">%s</span><span class="s2">&#39;].getSlice(rowstart, rowend, colstart, &quot;</span>
                <span class="s2">&quot;colend, name=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">tterm</span><span class="p">,</span> <span class="n">timeField</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">groundfailure</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gfail.html">gfail</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>