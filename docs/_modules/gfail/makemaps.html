
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>gfail.makemaps &#8212; groundfailure 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gfail.makemaps</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># stdlib imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LightSource</span><span class="p">,</span> <span class="n">LogNorm</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># from configobj import ConfigObj</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">shape</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span> <span class="k">as</span> <span class="n">PolygonSH</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">cm</span> <span class="k">as</span> <span class="n">cm2</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">maskoceans</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">block_reduce</span>
<span class="kn">from</span> <span class="nn">descartes</span> <span class="kn">import</span> <span class="n">PolygonPatch</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">import</span> <span class="nn">simplekml</span>
<span class="kn">from</span> <span class="nn">folium.utilities</span> <span class="kn">import</span> <span class="n">mercator_transform</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">mapio.gmt</span> <span class="kn">import</span> <span class="n">GMTGrid</span>
<span class="kn">from</span> <span class="nn">mapio.gdal</span> <span class="kn">import</span> <span class="n">GDALGrid</span>
<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="kn">import</span> <span class="n">GeoDict</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="kn">import</span> <span class="n">Grid2D</span>
<span class="kn">from</span> <span class="nn">mapio.basemapcity</span> <span class="kn">import</span> <span class="n">BasemapCities</span>
<span class="kn">from</span> <span class="nn">mapio.shake</span> <span class="kn">import</span> <span class="n">ShakeGrid</span>


<span class="c1"># Make fonts readable and recognizable by illustrator</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;Bitstream Vera Serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

<span class="c1"># # hex versions:</span>
<span class="c1"># DFCOLORS = [</span>
<span class="c1">#     &#39;#efefb34D&#39;,  # 30% opaque 4D</span>
<span class="c1">#     &#39;#e5c72f66&#39;,  # 40% opaque 66</span>
<span class="c1">#     &#39;#ea720780&#39;,  # 50% opaque 80</span>
<span class="c1">#     &#39;#c0375c99&#39;,  # 60% opaque 99</span>
<span class="c1">#     &#39;#5b28b299&#39;,  # 60% opaque 99</span>
<span class="c1">#     &#39;#1e1e6499&#39;   # 60% opaque 99</span>
<span class="c1"># ]</span>
<span class="n">DFCOLORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">0.94</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.39</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">DFBINS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.002</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>


<div class="viewcode-block" id="modelMap"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.modelMap">[docs]</a><span class="k">def</span> <span class="nf">modelMap</span><span class="p">(</span><span class="n">grids</span><span class="p">,</span> <span class="n">shakefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inventory_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plotorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskthreshes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scaletype</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">logscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ALPHA</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">maproads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mapcities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">isScenario</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roadfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">topofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cityfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">oceanfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roadcolor</span><span class="o">=</span><span class="s1">&#39;#6E6E6E&#39;</span><span class="p">,</span> <span class="n">watercolor</span><span class="o">=</span><span class="s1">&#39;#B8EEFF&#39;</span><span class="p">,</span>
             <span class="n">countrycolor</span><span class="o">=</span><span class="s1">&#39;#177F10&#39;</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">savepdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savepng</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printparam</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">ds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dstype</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">upsample</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create static maps of mapio grid layers (e.g. liquefaction or</span>
<span class="sd">    landslide models with their input layers).</span>

<span class="sd">    Args:</span>

<span class="sd">        grids (dict): Dictionary of N layers and metadata formatted like:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {</span>
<span class="sd">                    &#39;grid&#39;: mapio grid2D object,</span>
<span class="sd">                    &#39;label&#39;: &#39;label for colorbar and top line of subtitle&#39;,</span>
<span class="sd">                    &#39;type&#39;: &#39;output or input to model&#39;,</span>
<span class="sd">                    &#39;description&#39;: &#39;description for subtitle&#39;</span>
<span class="sd">                }</span>

<span class="sd">          Layer names must be unique. All grids must use the same bounds.</span>
<span class="sd">        shakefile (str): Optional ShakeMap file (url or full file path) to</span>
<span class="sd">            extract information for labels and folder names.</span>
<span class="sd">        suptitle (str): This will be displayed at the top of the plots and in</span>
<span class="sd">            the figure names.</span>
<span class="sd">        inventory_shapefile (str): Path to inventory file.</span>
<span class="sd">        plotorder (list): List of keys describing the order to plot the grids,</span>
<span class="sd">            if None and grids is an ordered dictionary, it will use the order</span>
<span class="sd">            of the dictionary, otherwise it will choose order which may be</span>
<span class="sd">            somewhat random but it will always put a probability grid first.</span>
<span class="sd">        maskthreshes (array): N x 1 array or list of lower thresholds for</span>
<span class="sd">            masking corresponding to order in plotorder or order of OrderedDict</span>
<span class="sd">            if plotorder is None. If grids is not an ordered dict and plotorder</span>
<span class="sd">            is not specified, this will not work right. If None (default),</span>
<span class="sd">            nothing will be masked.</span>
<span class="sd">        colormaps (list): List of strings of matplotlib colormaps (e.g.</span>
<span class="sd">            cm.autumn_r) corresponding to plotorder or order of dictionary if</span>
<span class="sd">            plotorder is None. The list can contain both strings and None e.g.</span>
<span class="sd">            colormaps = [&#39;cm.autumn&#39;, None, None, &#39;cm.jet&#39;] and None&#39;s will</span>
<span class="sd">            default to default colormap.</span>
<span class="sd">        boundaries (*): None to show entire study area, &#39;zoom&#39; to zoom in on</span>
<span class="sd">            the area of action (only works if there is a probability layer)</span>
<span class="sd">            using ``zthresh`` as a threshold, or a dictionary with keys &#39;xmin&#39;,</span>
<span class="sd">            &#39;xmax&#39;, &#39;ymin&#39;, and &#39;ymax&#39;.</span>
<span class="sd">        zthresh (float): Threshold for computing zooming bounds, only used if</span>
<span class="sd">            boundaries = &#39;zoom&#39;.</span>
<span class="sd">        scaletype (str): Type of scale for plotting, &#39;continuous&#39; or &#39;binned&#39;.</span>
<span class="sd">            Will be reflected in colorbar.</span>
<span class="sd">        lims (*): None or Nx1 list of tuples or numpy arrays corresponding to</span>
<span class="sd">            plotorder defining the limits for saturating the colorbar</span>
<span class="sd">            (vmin, vmax) if scaletype is continuous or the bins to use (clev)</span>
<span class="sd">            if scaletype if binned. The list can contain tuples, arrays, and</span>
<span class="sd">            Nones, e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                [(0., 10.), None, (0.1, 1.5), np.linspace(0., 1.5, 15)]</span>

<span class="sd">            When None is specified, the program will</span>
<span class="sd">            estimate the limits, when an array is specified but the scale</span>
<span class="sd">            type is continuous, vmin will be set to min(array) and vmax will</span>
<span class="sd">            be set to max(array).</span>
<span class="sd">        logscale (*): boolean to apply log colorbar to all plotted layers or</span>
<span class="sd">            list of booleans corresponding to each layer in grid.</span>
<span class="sd">        ALPHA (float): Transparency for mapping, if there is a hillshade that</span>
<span class="sd">            will plot below each layer, it is recommended to set this to at</span>
<span class="sd">            least 0.7.</span>
<span class="sd">        maproads (bool): Whether to show roads or not, default True, but</span>
<span class="sd">            requires that roadfile is specified and valid to work.</span>
<span class="sd">        mapcities (bool): Whether to show cities or not, default True, but</span>
<span class="sd">            requires that cityfile is specified and valid to work.</span>
<span class="sd">        isScenario (bool): Whether this is a scenario (True) or a real event</span>
<span class="sd">            (False) (default False).</span>
<span class="sd">        roadfolder (str): Full file path to folder containing road shapefiles.</span>
<span class="sd">        topofile (str): Path to topography grid (GDAL compatible). This is</span>
<span class="sd">            only needed to make a hillshade if a premade hillshade is not</span>
<span class="sd">            specified.</span>
<span class="sd">        cityfile (str): Path to Pager file containing city &amp; population</span>
<span class="sd">            information.</span>
<span class="sd">        oceanfile (str): Path to file ocean information.</span>
<span class="sd">        roadcolor (str): Color to use for roads, if plotted, default is</span>
<span class="sd">            &#39;#6E6E6E&#39;.</span>
<span class="sd">        watercolor (str): Color to use for oceans, lakes, and rivers, default</span>
<span class="sd">            is &#39;#B8EEFF&#39;.</span>
<span class="sd">        countrycolor (str): Color for country borders, default is &#39;#177F10&#39;.</span>
<span class="sd">        outputdir (str): Path for output figures, if edict is defined, a</span>
<span class="sd">            subfolder based on the event id will be created in this folder.</span>
<span class="sd">            If None, will use current directory.</span>
<span class="sd">        outfilename (str): Output file name.</span>
<span class="sd">        savepdf (bool): True to save pdf figure.</span>
<span class="sd">        savepng (bool): True to save png figure.</span>
<span class="sd">        showplots (bool): True to display plots</span>
<span class="sd">        printparam (bool): Show parameter values used to run model on plots.</span>
<span class="sd">        ds (bool): True to allow downsampling for display (necessary when</span>
<span class="sd">            arrays are quite large, False to not allow).</span>
<span class="sd">        dstype (str): What function to use in downsampling? Options are &#39;min&#39;,</span>
<span class="sd">            &#39;max&#39;, &#39;median&#39;, or &#39;mean&#39;.</span>
<span class="sd">        upsample (bool): True to upsample the layer to the DEM resolution for</span>
<span class="sd">            better looking hillshades.</span>

<span class="sd">    Returns:</span>

<span class="sd">        tuple: (newgrids, filenames), where:</span>
<span class="sd">            * newgrids: list of downsampled and trimmed version of input grids.</span>
<span class="sd">                If no modification was needed for plotting, this will be</span>
<span class="sd">                identical to grids but without the metadata.</span>
<span class="sd">            * filenames: a list of filenames that were created</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO:</span>
    <span class="c1">#     Change so that all input layers do not have to have the same bounds,</span>
    <span class="c1">#     test plotting multiple probability layers, and add option so that if</span>
    <span class="c1">#     PDF and PNG aren&#39;t output, opens plot on screen using plt.show().</span>

    <span class="k">if</span> <span class="n">suptitle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suptitle</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># display fig only if static fig not output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">showplots</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">savepdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">savepng</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

    <span class="n">defaultcolormap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span>

    <span class="k">if</span> <span class="n">shakefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getEventDict</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getShakeDict</span><span class="p">()</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_id&#39;</span><span class="p">]</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get output file location</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output location given, using current directory &#39;</span>
              <span class="s1">&#39;for outputs</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">outputdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>

    <span class="c1"># Get plotting order, if not specified</span>
    <span class="k">if</span> <span class="n">plotorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotorder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">colormaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>

    <span class="c1"># Get boundaries to use for all plots</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">boundaries</span> <span class="o">==</span> <span class="s1">&#39;zoom&#39;</span><span class="p">:</span>
        <span class="c1"># Find probability layer (will just take the maximum bounds if there is</span>
        <span class="c1"># more than one)</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keytemp</span> <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not find model layer to use for zoom, using &#39;</span>
                  <span class="s1">&#39;default boundaries&#39;</span><span class="p">)</span>
            <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lonmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e10</span>
            <span class="n">lonmin</span> <span class="o">=</span> <span class="mf">1.e10</span>
            <span class="n">latmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e10</span>
            <span class="n">latmin</span> <span class="o">=</span> <span class="mf">1.e10</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                <span class="c1"># get lat lons of areas affected and add, if no areas affected,</span>
                <span class="c1"># switch to shakemap boundaries</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
                <span class="c1"># backwards so it plots right</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">zthresh</span><span class="p">))</span>
                <span class="n">lonmin</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">lonmax</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">latmin</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">latmax</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># dummy fillers, only really care about bounds</span>
            <span class="n">boundaries1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span> <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
            <span class="c1"># Add padding around zoom limits</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">lonmin</span><span class="o">-</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmin</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmin</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">lonmax</span><span class="o">+</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmax</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax</span>
            <span class="k">if</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">latmin</span><span class="o">-</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmin</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymin</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">latmax</span><span class="o">+</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmax</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymax</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">(</span><span class="n">boundaries1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># SEE IF BOUNDARIES ARE SAME AS BOUNDARIES OF LAYERS</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tempgdict</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are almost the same as specified &#39;</span>
                  <span class="s1">&#39;boundaries, no cutting needed&#39;</span><span class="p">)</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">tempgdict</span>
            <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are not usable, using &#39;</span>
                          <span class="s1">&#39;default boundaries&#39;</span><span class="p">)</span>
                    <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Build dummy GeoDict</span>
                    <span class="n">boundaries</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">},</span>
                                         <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are not usable, using default &#39;</span>
                      <span class="s1">&#39;boundaries&#39;</span><span class="p">)</span>
                <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Pull out bounds for various uses</span>
    <span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span>
                                  <span class="n">boundaries</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>

    <span class="c1"># Determine if need a single panel or multi-panel plot and if multi-panel,</span>
    <span class="c1"># how many and how it will be arranged</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">numpanels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># create the figure and axes instances.</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numpanels</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numpanels</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">rowpan</span><span class="o">*</span><span class="mf">6.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">rowpan</span><span class="o">*</span><span class="mf">5.3</span><span class="p">)</span>

    <span class="n">fontsizemain</span> <span class="o">=</span> <span class="mf">14.</span>
    <span class="n">fontsizesub</span> <span class="o">=</span> <span class="mf">12.</span>
    <span class="n">fontsizesmallest</span> <span class="o">=</span> <span class="mf">10.</span>
    <span class="k">if</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">fontsizemain</span> <span class="o">=</span> <span class="mf">12.</span>
        <span class="n">fontsizesub</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="n">fontsizesmallest</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isScenario</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timestr</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b </span><span class="si">%d</span><span class="s1"> %Y&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;M</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> v</span><span class="si">%i</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                                           <span class="n">timestr</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
                                           <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizemain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizemain</span><span class="p">)</span>

    <span class="n">clear_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># Cut all of them and release extra memory</span>
    <span class="n">xbuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
    <span class="n">ybuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
    <span class="n">cutxmin</span> <span class="o">=</span> <span class="n">bxmin</span><span class="o">-</span><span class="n">xbuff</span>
    <span class="n">cutymin</span> <span class="o">=</span> <span class="n">bymin</span><span class="o">-</span><span class="n">ybuff</span>
    <span class="n">cutxmax</span> <span class="o">=</span> <span class="n">bxmax</span><span class="o">+</span><span class="n">xbuff</span>
    <span class="n">cutymax</span> <span class="o">=</span> <span class="n">bymax</span><span class="o">+</span><span class="n">ybuff</span>
    <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">newgrids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="n">templayer</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">templayer</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutxmax</span><span class="p">,</span>
                                          <span class="n">cutymin</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Cutting failed, </span><span class="si">%s</span><span class="s1">, continuing with full layers&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">newgrids</span> <span class="o">=</span> <span class="n">grids</span>
                <span class="k">continue</span>
        <span class="k">del</span> <span class="n">templayer</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newgrids</span> <span class="o">=</span> <span class="n">grids</span>
    <span class="n">tempgdict</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>

    <span class="c1"># Upsample layers to same as topofile if desired for better looking</span>
    <span class="c1"># hillshades</span>
    <span class="k">if</span> <span class="n">upsample</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">topofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topodict</span> <span class="o">=</span> <span class="n">GDALGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">topofile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">dx</span> <span class="ow">or</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">dy</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upsampling not possible, resolution of results &#39;</span>
                      <span class="s1">&#39;already smaller than DEM&#39;</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tempgdict1</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="n">xbuff</span><span class="p">,</span>
                                      <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="n">ybuff</span><span class="p">,</span>
                                      <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">xmax</span><span class="o">+</span><span class="n">xbuff</span><span class="p">,</span>
                                      <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">ymax</span><span class="o">+</span><span class="n">ybuff</span><span class="p">,</span>
                                      <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                                      <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
                                      <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span>
                                      <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">ny</span><span class="p">},</span>
                                     <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">tempgdict2</span> <span class="o">=</span> <span class="n">tempgdict1</span><span class="o">.</span><span class="n">getBoundsWithin</span><span class="p">(</span><span class="n">tempgdict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                    <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">subdivide</span><span class="p">(</span><span class="n">tempgdict2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upsampling failed, continuing&#39;</span><span class="p">)</span>

    <span class="c1"># Downsample all of them for plotting, if needed, and replace them in</span>
    <span class="c1"># grids (to save memory)</span>
    <span class="n">tempgrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span>
    <span class="n">inchesx</span><span class="p">,</span> <span class="n">inchesy</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()</span>
    <span class="n">divx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xsize</span><span class="o">/</span><span class="p">(</span><span class="mf">500.</span><span class="o">*</span><span class="n">inchesx</span><span class="p">)))</span>
    <span class="n">divy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ysize</span><span class="o">/</span><span class="p">(</span><span class="mf">500.</span><span class="o">*</span><span class="n">inchesy</span><span class="p">)))</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">gdict</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>  <span class="c1"># Will be replaced if downsampled</span>
    <span class="k">del</span> <span class="n">tempgrid</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">divx</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">divy</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">divx</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">divy</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span>
        <span class="k">elif</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span>
        <span class="k">elif</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;med&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="n">layergrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">layergrid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                               <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divy</span><span class="p">,</span> <span class="n">divx</span><span class="p">),</span>
                               <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                               <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span>
                                                <span class="n">layergrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span>
                                    <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divx</span><span class="p">,),</span>
                                    <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                                    <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span>
                                                <span class="n">layergrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span><span class="p">),</span>
                                    <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divy</span><span class="p">,),</span>
                                    <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                                    <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">gdict</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                 <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                 <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                 <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                 <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span>
                                 <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)},</span>
                                <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
            <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">gdict</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">layergrid</span><span class="p">,</span> <span class="n">dat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xsize</span><span class="p">)</span>
        <span class="c1"># backwards so it plots right side up</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ysize</span><span class="p">)</span>

    <span class="c1"># make meshgrid</span>
    <span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>

    <span class="c1"># See if there is an oceanfile for masking</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">PolygonSH</span><span class="p">(((</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutymin</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmax</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmax</span><span class="p">,</span> <span class="n">cutymin</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">oceanfile</span><span class="p">)</span>
            <span class="n">oc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">oc</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="c1"># make boundaries into a shape</span>
            <span class="n">ocean</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not able to read specified ocean file, will use default &#39;</span>
                  <span class="s1">&#39;ocean masking&#39;</span><span class="p">)</span>
            <span class="n">oceanfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inventory_shapefile</span><span class="p">)</span>
            <span class="n">invshp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymax</span><span class="p">)))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">inventory</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">invshp</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unable to read inventory shapefile specified, will not &#39;</span>
                  <span class="s1">&#39;plot inventory&#39;</span><span class="p">)</span>
            <span class="n">inventory_shapefile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Find cities that will be plotted</span>
    <span class="k">if</span> <span class="n">mapcities</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">cityfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mycity</span> <span class="o">=</span> <span class="n">BasemapCities</span><span class="o">.</span><span class="n">loadFromGeoNames</span><span class="p">(</span><span class="n">cityfile</span><span class="o">=</span><span class="n">cityfile</span><span class="p">)</span>
            <span class="n">bcities</span> <span class="o">=</span> <span class="n">mycity</span><span class="o">.</span><span class="n">limitByBounds</span><span class="p">((</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span><span class="p">))</span>
            <span class="n">bcities</span> <span class="o">=</span> <span class="n">bcities</span><span class="o">.</span><span class="n">limitByGrid</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cities_per_grid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not read in cityfile, not plotting cities&#39;</span><span class="p">)</span>
            <span class="n">mapcities</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cityfile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Load in topofile</span>
    <span class="k">if</span> <span class="n">topofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topomap</span> <span class="o">=</span> <span class="n">GDALGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">topofile</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                    <span class="n">samplegeodict</span><span class="o">=</span><span class="n">gdict</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">topomap</span> <span class="o">=</span> <span class="n">GMTGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">topofile</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                   <span class="n">samplegeodict</span><span class="o">=</span><span class="n">gdict</span><span class="p">)</span>
        <span class="n">topodata</span> <span class="o">=</span> <span class="n">topomap</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># mask oceans if don&#39;t have ocean shapefile</span>
        <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">topodata</span> <span class="o">=</span> <span class="n">maskoceans</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">,</span> <span class="n">topodata</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                                  <span class="n">grid</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">inlands</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no hillshade is possible</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">topomap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">topodata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Load in roads, if needed</span>
    <span class="n">roadslist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">maproads</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">roadfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roadslist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">roadfolder</span><span class="p">):</span>
                <span class="n">road1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roadfolder</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
                <span class="n">shpfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">road1</span><span class="p">,</span> <span class="s1">&#39;*.shp&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shpfiles</span><span class="p">):</span>
                    <span class="n">shpfile</span> <span class="o">=</span> <span class="n">shpfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shpfile</span><span class="p">)</span>
                    <span class="n">shapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymax</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">shapeid</span><span class="p">,</span> <span class="n">shapedict</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
                        <span class="n">roadslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapedict</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not able to plot roads&#39;</span><span class="p">)</span>

    <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
        <span class="n">layergrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">layer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">rowpan</span><span class="p">,</span> <span class="n">colpan</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">clat</span> <span class="o">=</span> <span class="n">bymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">clon</span> <span class="o">=</span> <span class="n">bxmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="c1"># setup of basemap (&#39;lcc&#39; = lambert conformal conic, or tmerc</span>
        <span class="c1"># is transverse mercator).</span>
        <span class="c1"># use major and minor sphere radii from WGS84 ellipsoid.</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">bymin</span><span class="p">,</span>
                    <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">bxmax</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">bymax</span><span class="p">,</span>
                    <span class="n">rsphere</span><span class="o">=</span><span class="p">(</span><span class="mf">6378137.00</span><span class="p">,</span> <span class="mf">6356752.3142</span><span class="p">),</span>
                    <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">area_thresh</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;tmerc&#39;</span><span class="p">,</span>
                    <span class="n">lat_0</span><span class="o">=</span><span class="n">clat</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">clon</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">)</span>  <span class="c1"># get projection coordinates</span>
        <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wid</span><span class="p">,</span> <span class="n">ht</span> <span class="o">=</span> <span class="n">axsize</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">axsize</span><span class="o">.</span><span class="n">height</span>
        <span class="n">default1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colormaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">default1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Find preferred default color map for each type of layer if no</span>
        <span class="c1"># colormaps found</span>
        <span class="k">if</span> <span class="n">default1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prob&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;pga&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="s1">&#39;pgv&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;cohesion&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="s1">&#39;friction&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;fs&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span>
            <span class="k">elif</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">gnuplot2</span>
            <span class="k">elif</span> <span class="s1">&#39;precip&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm2</span><span class="o">.</span><span class="n">s3pcpn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">defaultcolormap</span>

        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ptopo</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">transform_scalar</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">topodata</span><span class="p">),</span> <span class="n">lons</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                    <span class="n">lats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">wid</span><span class="p">)),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">ht</span><span class="p">)),</span> <span class="n">returnxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkbounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># use lightsource class to make our shaded topography</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">135</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">ls1</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">ls2</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">225</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">intensity1</span> <span class="o">=</span> <span class="n">ls1</span><span class="o">.</span><span class="n">hillshade</span><span class="p">(</span><span class="n">ptopo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vert_exag</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">intensity2</span> <span class="o">=</span> <span class="n">ls2</span><span class="o">.</span><span class="n">hillshade</span><span class="p">(</span><span class="n">ptopo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vert_exag</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity1</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">intensity2</span><span class="o">*</span><span class="mf">0.5</span>

        <span class="c1"># Get the data</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">layergrid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># mask out anything below any specified thresholds</span>

        <span class="c1"># if logscale is not False and len(logscale) == len(plotorder):</span>
        <span class="c1">#     if logscale[k] is True:</span>
        <span class="c1">#         dat = np.log10(dat)</span>
        <span class="c1">#         label1 = r&#39;$log_{10}$(&#39; + label1 + &#39;)&#39;</span>

        <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span>
                                           <span class="mf">0.25</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find order of range to know how to scale</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">order</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mf">1.</span>

                    <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                                <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clev</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find order of range to know how to scale</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">scal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">order</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scal</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                        <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Adjust to colorbar levels</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span> <span class="o">&gt;=</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="c1"># So colorbar saturates at top</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logscale</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="c1"># Put it in a list so it won&#39;t break things later</span>
                <span class="n">logscale</span> <span class="o">=</span> <span class="p">[</span><span class="n">logscale</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

        <span class="c1"># Might need to move this up to before downsampling...</span>
        <span class="c1"># might give illusion of no hazard in places where there is some that</span>
        <span class="c1"># just got averaged out.</span>
        <span class="k">if</span> <span class="n">maskthreshes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskthreshes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;=</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>

        <span class="c1"># Mask out cells overlying oceans or block with a shapefile if</span>
        <span class="c1"># available</span>
        <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">maskoceans</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                             <span class="n">grid</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">inlands</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ocean</span><span class="p">)</span> <span class="ow">is</span> <span class="n">PolygonSH</span><span class="p">:</span>
                <span class="n">ocean</span> <span class="o">=</span> <span class="p">[</span><span class="n">ocean</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">ocean</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">getProjectedPatch</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#006280&quot;</span><span class="p">,</span>
                                          <span class="n">facecolor</span><span class="o">=</span><span class="n">watercolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                          <span class="n">zorder</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">in1</span> <span class="ow">in</span> <span class="n">inventory</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;point&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">in1</span><span class="p">)):</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">in1</span><span class="o">.</span><span class="n">xy</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                              <span class="n">zorder</span><span class="o">=</span><span class="mi">100001</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">in1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                    <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">clear_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># Plot it up</span>
        <span class="n">dat_im</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">transform_scalar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span>
                                    <span class="n">lons</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                                    <span class="n">lats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">wid</span><span class="p">)),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">ht</span><span class="p">)),</span>
                                    <span class="n">returnxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">checkbounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logscale</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Drape over hillshade</span>
        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># turn data into an RGBA image</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">palette</span>
            <span class="c1"># adjust data so scaled between vmin and vmax and between 0 and 1</span>
            <span class="n">dat1</span> <span class="o">=</span> <span class="n">dat_im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dat1</span><span class="p">[</span><span class="n">dat1</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">dat1</span><span class="p">[</span><span class="n">dat1</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>
            <span class="n">dat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat1</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span>
            <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">dat1</span><span class="p">)</span>
            <span class="n">maskvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rgba_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">rgb</span><span class="p">[</span><span class="n">maskvals</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">draped_hsv</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">blend_hsv</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">draped_hsv</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>
            <span class="c1"># This is just a dummy layer that will be deleted to make the</span>
            <span class="c1"># colorbar look right</span>
            <span class="n">panelhandle</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dat_im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">,</span>
                                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panelhandle</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dat_im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">,</span>
                                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cbfmt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">vmax</span> <span class="o">&gt;</span> <span class="mf">5.</span><span class="p">:</span>  <span class="c1"># (vmax - vmin) &gt; len(clev):</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">panelhandle</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;proportional&#39;</span><span class="p">,</span>
                                <span class="n">ticks</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.036</span><span class="p">,</span>
                                <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                                <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">panelhandle</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.036</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                                <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">panelhandle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">parallels</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">getMapLines</span><span class="p">(</span><span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">labelstyle</span><span class="o">=</span><span class="s1">&#39;+/-&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">xoffset</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">100.</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">getMapLines</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">labelstyle</span><span class="o">=</span><span class="s1">&#39;+/-&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">100.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">parallels</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parallels</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># draw roads on the map, if they were provided to us</span>
        <span class="k">if</span> <span class="n">maproads</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">roadslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">road</span> <span class="ow">in</span> <span class="n">roadslist</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">road</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">])</span>
                        <span class="n">roadx</span><span class="p">,</span> <span class="n">roady</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">))</span>
                        <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">roadx</span><span class="p">,</span> <span class="n">roady</span><span class="p">)</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span><span class="p">,</span> <span class="n">roadcolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Failed to plot roads, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># add city names to map</span>
        <span class="k">if</span> <span class="n">mapcities</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">cityfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="c1"># Only need to choose cities first time and then apply to rest</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fcities</span> <span class="o">=</span> <span class="n">bcities</span><span class="o">.</span><span class="n">limitByMapCollision</span><span class="p">(</span>
                        <span class="n">m</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="n">ctlats</span><span class="p">,</span> <span class="n">ctlons</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">fcities</span><span class="o">.</span><span class="n">getCities</span><span class="p">()</span>
                    <span class="n">cxis</span><span class="p">,</span> <span class="n">cyis</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">ctlons</span><span class="p">,</span> <span class="n">ctlats</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ctlat</span><span class="p">,</span> <span class="n">ctlon</span><span class="p">,</span> <span class="n">cxi</span><span class="p">,</span> <span class="n">cyi</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> \
                        <span class="nb">zip</span><span class="p">(</span><span class="n">ctlats</span><span class="p">,</span> <span class="n">ctlons</span><span class="p">,</span> <span class="n">cxis</span><span class="p">,</span> <span class="n">cyis</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ctlon</span><span class="p">,</span> <span class="n">ctlat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                              <span class="n">zorder</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cxi</span><span class="p">,</span> <span class="n">cyi</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to plot cities, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># draw star at epicenter</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">elat</span><span class="p">,</span> <span class="n">elon</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
            <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">elon</span><span class="p">,</span> <span class="n">elat</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">10000.</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">drawmapboundary</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">fillcontinents</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">clear_color</span><span class="p">,</span> <span class="n">lake_color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawrivers</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>

        <span class="c1"># draw country boundaries</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawcountries</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">countrycolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># add map scale</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">((</span><span class="n">bxmax</span><span class="o">+</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">bymin</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)),</span> <span class="n">clon</span><span class="p">,</span> <span class="n">clat</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((((</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">*</span><span class="mi">111</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">barstyle</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Add border</span>
        <span class="n">autoAxis</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
                         <span class="n">autoAxis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mf">0.4</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mf">1e8</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">source: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">sref</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">label1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizesub</span><span class="p">)</span>

        <span class="c1"># draw scenario watermark, if scenario</span>
        <span class="k">if</span> <span class="n">isScenario</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">clon</span><span class="p">,</span> <span class="n">clat</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="s1">&#39;SCENARIO&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="c1"># if ds: # Could add this to print &quot;downsampled&quot; on map</span>
        <span class="c1">#     plt.text()</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># adjust single level plot</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
            <span class="n">ht2</span> <span class="o">=</span> <span class="n">axsize</span><span class="o">.</span><span class="n">height</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">ht2</span><span class="o">*</span><span class="mf">1.6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Make room for suptitle - tight layout doesn&#39;t account for it</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">printparam</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
            <span class="n">paramstring</span> <span class="o">=</span> <span class="s1">&#39;Model parameters: &#39;</span>
            <span class="n">halfway</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">halfway</span> <span class="ow">and</span> <span class="n">colpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">paramstring</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">paramstring</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">paramstring</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">paramstring</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizesmallest</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not display model parameters&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eventid</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eventid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">outfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y_%H%M&#39;</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pdf&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">eventid</span><span class="p">,</span> <span class="n">suptitle</span><span class="p">,</span> <span class="n">time1</span><span class="p">))</span>
        <span class="n">pngfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.png&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">eventid</span><span class="p">,</span> <span class="n">suptitle</span><span class="p">,</span> <span class="n">time1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">outfilename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">pngfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">outfilename</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">savepdf</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving map output to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">savepng</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving map output to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pngfile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showplots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newgrids</span><span class="p">,</span> <span class="n">filenames</span></div>


<div class="viewcode-block" id="getMapLines"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.getMapLines">[docs]</a><span class="k">def</span> <span class="nf">getMapLines</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">nlines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get equally spaced lat or lon lines for mapping</span>

<span class="sd">    Args:</span>
<span class="sd">        dmin (float): minimum lat or lon</span>
<span class="sd">        dmax (float): maximum lat or lon</span>
<span class="sd">        nlines (int): number of lines</span>

<span class="sd">    Returns:</span>
<span class="sd">        array: location of lines</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">drange</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">-</span><span class="n">dmin</span>
    <span class="k">if</span> <span class="n">drange</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">near</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">drange</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">near</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">near</span> <span class="o">=</span> <span class="mf">0.125</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="n">roundToNearest</span><span class="p">(</span><span class="n">drange</span><span class="o">/</span><span class="n">nlines</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># make the increment the closest power of 10</span>
        <span class="n">near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">drange</span><span class="p">)))</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">drange</span><span class="o">/</span><span class="n">nlines</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmin</span> <span class="o">=</span> <span class="n">floorToNearest</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmax</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newdmin</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmax</span> <span class="o">=</span> <span class="n">floorToNearest</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="n">darray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">newdmin</span><span class="p">,</span> <span class="n">newdmax</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">darray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
        <span class="n">darray</span> <span class="o">=</span> <span class="n">darray</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">darray</span></div>


<div class="viewcode-block" id="getProjectedPatch"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.getProjectedPatch">[docs]</a><span class="k">def</span> <span class="nf">getProjectedPatch</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">edgecolor</span><span class="p">,</span> <span class="n">facecolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project a polygon to coordinate system used in Basemap m</span>

<span class="sd">    Args:</span>
<span class="sd">        polygon: list of shapely polygons to project</span>
<span class="sd">        m: Basemap map to project polygon to</span>
<span class="sd">        edgecolor: color to use for polygon edge</span>
<span class="sd">        facecolor: color to use to fill polygon</span>
<span class="sd">        lw: line width for edge of polygon</span>
<span class="sd">        zorder: plotting order of polygons</span>

<span class="sd">    Returns:</span>
<span class="sd">        patch: patch of projected polygons that can be added to map figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">polyjson</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="n">tlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">polyjson</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sequence</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
    <span class="n">polyjson</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tlist</span><span class="p">)</span>
    <span class="n">ppolygon</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">polyjson</span><span class="p">)</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="n">ppolygon</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">patch</span></div>


<div class="viewcode-block" id="roundToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.roundToNearest">[docs]</a><span class="k">def</span> <span class="nf">roundToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">roundValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, rounded to nearest roundValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be rounded.</span>
<span class="sd">        roundValue (float): Number to which the value should be rounded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Rounded value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">roundValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">roundValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">roundValue</span> <span class="o">=</span> <span class="n">roundValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">roundValue</span><span class="p">)</span><span class="o">*</span><span class="n">roundValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">roundValue</span><span class="p">)</span><span class="o">*</span><span class="n">roundValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="floorToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.floorToNearest">[docs]</a><span class="k">def</span> <span class="nf">floorToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">floorValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, floored to nearest floorValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be floored.</span>
<span class="sd">        floorValue (float): Number to which the value should be floored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Floored value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">floorValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">floorValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">floorValue</span> <span class="o">=</span> <span class="n">floorValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">floorValue</span><span class="p">)</span><span class="o">*</span><span class="n">floorValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">floorValue</span><span class="p">)</span><span class="o">*</span><span class="n">floorValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="ceilToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.ceilToNearest">[docs]</a><span class="k">def</span> <span class="nf">ceilToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ceilValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, ceiled to nearest ceilValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be ceiled.</span>
<span class="sd">        ceilValue (float): Number to which the value should be ceiled.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Ceiling-ed value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ceilValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ceilValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">ceilValue</span> <span class="o">=</span> <span class="n">ceilValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">ceilValue</span><span class="p">)</span><span class="o">*</span><span class="n">ceilValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">ceilValue</span><span class="p">)</span><span class="o">*</span><span class="n">ceilValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="setupsync"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.setupsync">[docs]</a><span class="k">def</span> <span class="nf">setupsync</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">plotorder</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="n">colormaps</span><span class="p">,</span> <span class="n">defaultcolormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span><span class="p">,</span>
              <span class="n">logscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get colors that will be used for all colorbars from reference grid</span>

<span class="sd">    Args:</span>
<span class="sd">        sync(str): If False, will exit program, else corresponds to the</span>
<span class="sd">            shortref of the model which should serve as the template for</span>
<span class="sd">            the colorbars used by all other models. All other models must</span>
<span class="sd">            have the exact same number of bins</span>
<span class="sd">        plotorder (list): List of keys of shortrefs of the grids that will be</span>
<span class="sd">            plotted.</span>
<span class="sd">        lims (*): Nx1 list of tuples or numpy arrays corresponding to</span>
<span class="sd">            plotorder defining the bin edges to use for each model.</span>
<span class="sd">            Example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                [(0., 0.1, 0.2, 0.3), np.linspace(0., 1.5, 15)]</span>

<span class="sd">        colormaps (list): List of strings of matplotlib colormaps (e.g.</span>
<span class="sd">            cm.autumn_r) corresponding to plotorder</span>
<span class="sd">        defaultcolormap (matplotlib colormap): Colormap to use if</span>
<span class="sd">            colormaps is not defined. default cm.CMRmap_r</span>
<span class="sd">        logscale (*): If not None, then a list of booleans corresponding to</span>
<span class="sd">            plotorder stating whether to use log scaling in determining colors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (sync, colorlist, lim1) where:</span>
<span class="sd">            * sync (bool): whether or not colorbars are/can be synced</span>
<span class="sd">            * colorlist (list): list of rgba colors that will be applied to all</span>
<span class="sd">                models regardless of bin edge values</span>
<span class="sd">            * lim1 (array): bin edges of model to which others are synced</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sync</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">sync</span> <span class="ow">in</span> <span class="n">plotorder</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="n">indx</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sync</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Make sure lims exist and all have the same number of bins&#39;</span>

        <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">lim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">sum1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lim</span> <span class="ow">in</span> <span class="n">lims</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sum1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lim1</span><span class="p">):</span>
                <span class="n">sum1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sum1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot sync colorbars, different number of bins or lims not</span><span class="se">\</span>
<span class="s1">                  specified&#39;</span><span class="p">)</span>
            <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">sync</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">palette1</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">palette1</span> <span class="o">=</span> <span class="n">defaultcolormap</span>
        <span class="c1"># palette1.set_bad(clear_color, alpha=0.0)</span>
        <span class="k">if</span> <span class="n">logs</span><span class="p">:</span>
            <span class="n">cNorm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">midpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lim1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># geometric mean for midpoints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cNorm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">midpts</span> <span class="o">=</span> <span class="p">(</span><span class="n">lim1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette1</span><span class="p">)</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">midpts</span><span class="p">:</span>
            <span class="n">colorlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot sync colorbars, different number of bins or lims not </span><span class="se">\</span>
<span class="s1">              specified&#39;</span><span class="p">)</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lim1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">sync</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">lim1</span></div>


<div class="viewcode-block" id="create_kmz"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.create_kmz">[docs]</a><span class="k">def</span> <span class="nf">create_kmz</span><span class="p">(</span><span class="n">maplayer</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create kmz files of models</span>

<span class="sd">    Args:</span>
<span class="sd">        maplayer (dict): Dictionary of one model result formatted like:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {</span>
<span class="sd">                    &#39;grid&#39;: mapio grid2D object,</span>
<span class="sd">                    &#39;label&#39;: &#39;label for colorbar and top line of subtitle&#39;,</span>
<span class="sd">                    &#39;type&#39;: &#39;output or input to model&#39;,</span>
<span class="sd">                    &#39;description&#39;: &#39;description for subtitle&#39;</span>
<span class="sd">                }</span>
<span class="sd">        outfile (str): File extension</span>
<span class="sd">        mask (float): make all cells below this value transparent</span>
<span class="sd">        levels (array): list of bin edges for each color, must be same length</span>
<span class="sd">        colorlist (array): list of colors for each bin, should be length one less than levels</span>

<span class="sd">    Returns:</span>
<span class="sd">        kmz file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Figure out lims</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">DFBINS</span>
    <span class="k">if</span> <span class="n">colorlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="n">DFCOLORS</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;len(levels) must be one longer than len(colorlist)&#39;</span><span class="p">)</span>

    <span class="c1"># Make place to put temporary files</span>
    <span class="n">temploc</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>

    <span class="c1"># Figure out file names</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;.kmz&#39;</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.kmz&#39;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">mapfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temploc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tiff&#39;</span> <span class="o">%</span> <span class="n">basename</span><span class="p">)</span>
    <span class="n">legshort</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_legend.png&#39;</span> <span class="o">%</span> <span class="n">basename</span>
    <span class="n">legfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temploc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">legshort</span><span class="p">)</span>

    <span class="c1"># Make colored geotiff</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">make_rgba</span><span class="p">(</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colorlist</span><span class="o">=</span><span class="n">colorlist</span><span class="p">)</span>
    <span class="n">rgba_img</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">out</span>
    <span class="c1"># Save as a tiff</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">mapfile</span><span class="p">,</span> <span class="n">rgba_img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># Start creating kmz</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Kml</span><span class="p">()</span>

    <span class="c1"># Set zoom window</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">document</span>  <span class="c1"># have to put lookat in root document directory</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">altitudemode</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">AltitudeMode</span><span class="o">.</span><span class="n">relativetoground</span>
    <span class="n">boundaries1</span> <span class="o">=</span> <span class="n">get_zoomextent</span><span class="p">(</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">])</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">lookat</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]])</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">lookat</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]])</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">lookat</span><span class="o">.</span><span class="n">altitude</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">lookat</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">111.</span> <span class="o">*</span> <span class="mf">1000.</span>  <span class="c1"># dist in m from point</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;USGS near-real-time earthquake-triggered </span><span class="si">%s</span><span class="s1"> model for </span><span class="se">\</span>
<span class="s1">                       event id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>\
                       <span class="p">[</span><span class="s1">&#39;modeltype&#39;</span><span class="p">],</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;event_id&#39;</span><span class="p">])</span>

    <span class="n">prob</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">newgroundoverlay</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">href</span> <span class="o">=</span> <span class="s1">&#39;files/</span><span class="si">%s</span><span class="s1">.tiff&#39;</span> <span class="o">%</span> <span class="n">basename</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">latlonbox</span><span class="o">.</span><span class="n">north</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">latlonbox</span><span class="o">.</span><span class="n">south</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">latlonbox</span><span class="o">.</span><span class="n">east</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">latlonbox</span><span class="o">.</span><span class="n">west</span> <span class="o">=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">L</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">mapfile</span><span class="p">)</span>

    <span class="c1"># Add legend and USGS icon as screen overlays</span>
    <span class="c1"># Make legend</span>
    <span class="n">make_legend</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">legfile</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
    
    <span class="n">size1</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">newscreenoverlay</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Legend&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size1</span><span class="p">)</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">href</span> <span class="o">=</span> <span class="s1">&#39;files/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">legshort</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">screenxy</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">ScreenXY</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span>
                                      <span class="n">yunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
    <span class="n">L</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">legfile</span><span class="p">)</span>

    <span class="n">size2</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">newscreenoverlay</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;USGS&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size2</span><span class="p">)</span>
    <span class="n">icon</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">href</span> <span class="o">=</span> <span class="s1">&#39;files/USGS_ID_white.png&#39;</span>
    <span class="n">icon</span><span class="o">.</span><span class="n">screenxy</span> <span class="o">=</span> <span class="n">simplekml</span><span class="o">.</span><span class="n">ScreenXY</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span>
                                       <span class="n">yunits</span><span class="o">=</span><span class="n">simplekml</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
    <span class="n">L</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;USGS_ID_white.png&#39;</span><span class="p">))</span>

    <span class="n">L</span><span class="o">.</span><span class="n">savekmz</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="get_zoomextent"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.get_zoomextent">[docs]</a><span class="k">def</span> <span class="nf">get_zoomextent</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">propofmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the extent that contains all values with probabilities exceeding</span>
<span class="sd">    a threshold in order to determine ideal zoom level for interactive map</span>
<span class="sd">    If nothing is above the threshold, uses the full extent</span>

<span class="sd">    Args:</span>
<span class="sd">        grid: grid2d of model output</span>
<span class="sd">        propofmax (float): Proportion of maximum that should be fully included</span>
<span class="sd">            within the bounds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        * boundaries: a dictionary with keys &#39;xmin&#39;, &#39;xmax&#39;, &#39;ymin&#39;, and</span>
<span class="sd">         &#39;ymax&#39; that defines the zoomed boundaries in geographic coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">getData</span><span class="p">())</span>

    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maximum</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">boundaries1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>
        <span class="c1"># If nothing is above the threshold, use full extent</span>
        <span class="k">return</span> <span class="n">boundaries1</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">propofmax</span> <span class="o">*</span> <span class="n">maximum</span>

    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
    <span class="n">lonmin</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">lonmax</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">latmin</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">latmax</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">boundaries1</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">lonmin</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmin</span>
    <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">lonmax</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax</span>
    <span class="k">if</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">latmin</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymin</span>
    <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">latmax</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymax</span>

    <span class="k">return</span> <span class="n">boundaries1</span>   </div>


<div class="viewcode-block" id="make_rgba"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.make_rgba">[docs]</a><span class="k">def</span> <span class="nf">make_rgba</span><span class="p">(</span><span class="n">grid2D</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">mercator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make an rgba (red, green, blue, alpha) grid out of raw data values and</span>
<span class="sd">    provide extent and limits needed to save as an image file</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        grid2D: Mapio Grid2D object of result to mape </span>
<span class="sd">        levels (array): list of bin edges for each color, must be same length</span>
<span class="sd">        colorlist (array): list of colors for each bin, should be length one</span>
<span class="sd">            less than levels</span>
<span class="sd">        mask (float): mask all values below this value</span>
<span class="sd">        mercator (bool): project to web mercator (needed for leaflet, not</span>
<span class="sd">                 for kmz)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (rgba_img, extent, lmin, lmax, cmap), where:</span>
<span class="sd">            * rgba_img: rgba (red green blue alpha) image</span>
<span class="sd">            * extent: list of outside corners of image,</span>
<span class="sd">                [minlat, maxlat, minlon, maxlon]</span>
<span class="sd">            * lmin: lowest bin edge</span>
<span class="sd">            * lmax: highest bin edge</span>
<span class="sd">            * cmap: colormap corresponding to image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">grid2D</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">data1</span> <span class="o">&lt;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="n">geodict</span> <span class="o">=</span> <span class="n">grid2D</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">geodict</span><span class="o">.</span><span class="n">xmin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">geodict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">geodict</span><span class="o">.</span><span class="n">xmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">geodict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">geodict</span><span class="o">.</span><span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">geodict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
        <span class="n">geodict</span><span class="o">.</span><span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">geodict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">lmin</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lmax</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data1</span><span class="p">))</span>
    <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">data2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mercator</span><span class="p">:</span>
        <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">mercator_transform</span><span class="p">(</span>
            <span class="n">rgba_img</span><span class="p">,</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rgba_img</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">cmap</span></div>


<div class="viewcode-block" id="make_legend"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.make_legend">[docs]</a><span class="k">def</span> <span class="nf">make_legend</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make legend file</span>

<span class="sd">    Args:</span>

<span class="sd">        levels (array): list of bin edges for each color, must be same length</span>
<span class="sd">        colorlist (array): list of colors for each bin, should be length one</span>
<span class="sd">            less than levels</span>
<span class="sd">        filename (str): File extension of legend file</span>
<span class="sd">        orientation (str): orientation of colorbar, &#39;horizontal&#39; or &#39;vertical&#39;</span>
<span class="sd">        title (str): title of legend (usually units)</span>
<span class="sd">        transparent (bool): if True, background will be transparent</span>

<span class="sd">    Returns:</span>
<span class="sd">        figure of legend</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt; </span><span class="si">%1.1f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,)]</span>
    <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">db</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
        <span class="c1"># Flip order to darker on top</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">colors1</span> <span class="o">=</span> <span class="n">colorlist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors1</span><span class="p">)</span><span class="o">-</span><span class="mf">1.7</span><span class="p">))</span>
        <span class="n">clearind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">maxind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors1</span> <span class="o">=</span> <span class="n">colorlist</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="c1"># DPI = fig.get_dpi()</span>
        <span class="c1"># fig.set_size_inches(440/DPI, 83/DPI)</span>
        <span class="n">clearind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="c1"># draw square</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">clearind</span><span class="p">:</span>
            <span class="n">color1</span> <span class="o">=</span> <span class="n">colors1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">color1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># make completely transparent</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">color1</span> <span class="o">=</span> <span class="n">colors1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">color1</span> <span class="o">=</span> <span class="n">colors1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">color1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># make less transparent</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">maxind</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&gt; </span><span class="si">%1.0f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">color1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                          <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.82</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># , left=0.01, right=0.99, top=0.99, bottom=0.01)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="c1"># plt.tight_layout()</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">groundfailure</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gfail.html">gfail</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>