
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gfail.makemaps &#8212; groundfailure 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gfail.makemaps</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># stdlib imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LightSource</span><span class="p">,</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">matplotlib.colorbar</span> <span class="k">import</span> <span class="n">ColorbarBase</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="c1">#from configobj import ConfigObj</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">branca.colormap</span> <span class="k">as</span> <span class="nn">cmb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">shape</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Polygon</span> <span class="k">as</span> <span class="n">PolygonSH</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">cm</span> <span class="k">as</span> <span class="n">cm2</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">maskoceans</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="k">import</span> <span class="n">block_reduce</span>
<span class="kn">from</span> <span class="nn">descartes</span> <span class="k">import</span> <span class="n">PolygonPatch</span>
<span class="kn">import</span> <span class="nn">shapefile</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">from</span> <span class="nn">folium</span> <span class="k">import</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">GeoJson</span>
<span class="kn">from</span> <span class="nn">folium.features</span> <span class="k">import</span> <span class="n">GeoJson</span> <span class="k">as</span> <span class="n">GeoJson1</span>
<span class="kn">from</span> <span class="nn">folium.features</span> <span class="k">import</span> <span class="n">RectangleMarker</span>
<span class="kn">from</span> <span class="nn">mapio.shake</span> <span class="k">import</span> <span class="n">ShakeGrid</span>
<span class="kn">from</span> <span class="nn">impactutils.io.cmd</span> <span class="k">import</span> <span class="n">get_command_output</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">mapio.gmt</span> <span class="k">import</span> <span class="n">GMTGrid</span>
<span class="kn">from</span> <span class="nn">mapio.gdal</span> <span class="k">import</span> <span class="n">GDALGrid</span>
<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="k">import</span> <span class="n">GeoDict</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="k">import</span> <span class="n">Grid2D</span>
<span class="kn">from</span> <span class="nn">mapio.basemapcity</span> <span class="k">import</span> <span class="n">BasemapCities</span>
<span class="kn">from</span> <span class="nn">gfail.stats</span> <span class="k">import</span> <span class="n">computeStats</span>
<span class="kn">from</span> <span class="nn">gfail.utilities</span> <span class="k">import</span> <span class="n">get_event_comcat</span><span class="p">,</span> <span class="n">parseConfigLayers</span>


<span class="c1"># Make fonts readable and recognizable by illustrator</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="p">[</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;Bitstream Vera Serif&#39;</span><span class="p">,</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="modelMap"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.modelMap">[docs]</a><span class="k">def</span> <span class="nf">modelMap</span><span class="p">(</span><span class="n">grids</span><span class="p">,</span> <span class="n">shakefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inventory_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plotorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskthreshes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zthresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scaletype</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">logscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ALPHA</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">maproads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mapcities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">isScenario</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roadfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">topofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cityfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">oceanfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roadcolor</span><span class="o">=</span><span class="s1">&#39;#6E6E6E&#39;</span><span class="p">,</span> <span class="n">watercolor</span><span class="o">=</span><span class="s1">&#39;#B8EEFF&#39;</span><span class="p">,</span>
             <span class="n">countrycolor</span><span class="o">=</span><span class="s1">&#39;#177F10&#39;</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">savepdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savepng</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printparam</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">dstype</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">upsample</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create static maps of mapio grid layers (e.g. liquefaction or</span>
<span class="sd">    landslide models with their input layers).</span>

<span class="sd">    Args:</span>
<span class="sd">        grids (dict): Dictionary of N layers and metadata formatted like:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {</span>
<span class="sd">                    &#39;grid&#39;: mapio grid2D object,</span>
<span class="sd">                    &#39;label&#39;: &#39;label for colorbar and top line of subtitle&#39;,</span>
<span class="sd">                    &#39;type&#39;: &#39;output or input to model&#39;,</span>
<span class="sd">                    &#39;description&#39;: &#39;description for subtitle&#39;</span>
<span class="sd">                }</span>

<span class="sd">          Layer names must be unique. All grids must use the same bounds.</span>
<span class="sd">        shakefile (str): Optional ShakeMap file (url or full file path) to</span>
<span class="sd">            extract information for labels and folder names.</span>
<span class="sd">        suptitle (str): This will be displayed at the top of the plots and in</span>
<span class="sd">            the figure names.</span>
<span class="sd">        inventory_shapefile (str): Path to inventory file.</span>
<span class="sd">        plotorder (list): List of keys describing the order to plot the grids,</span>
<span class="sd">            if None and grids is an ordered dictionary, it will use the order</span>
<span class="sd">            of the dictionary, otherwise it will choose order which may be</span>
<span class="sd">            somewhat random but it will always put a probability grid first.</span>
<span class="sd">        maskthreshes (array): N x 1 array or list of lower thresholds for</span>
<span class="sd">            masking corresponding to order in plotorder or order of OrderedDict</span>
<span class="sd">            if plotorder is None. If grids is not an ordered dict and plotorder</span>
<span class="sd">            is not specified, this will not work right. If None (default),</span>
<span class="sd">            nothing will be masked.</span>
<span class="sd">        colormaps (list): List of strings of matplotlib colormaps (e.g.</span>
<span class="sd">            cm.autumn_r) corresponding to plotorder or order of dictionary if</span>
<span class="sd">            plotorder is None. The list can contain both strings and None e.g.</span>
<span class="sd">            colormaps = [&#39;cm.autumn&#39;, None, None, &#39;cm.jet&#39;] and None&#39;s will</span>
<span class="sd">            default to default colormap.</span>
<span class="sd">        boundaries (*): None to show entire study area, &#39;zoom&#39; to zoom in on</span>
<span class="sd">            the area of action (only works if there is a probability layer)</span>
<span class="sd">            using ``zthresh`` as a threshold, or a dictionary with keys &#39;xmin&#39;,</span>
<span class="sd">            &#39;xmax&#39;, &#39;ymin&#39;, and &#39;ymax&#39;.</span>
<span class="sd">        zthresh (float): Threshold for computing zooming bounds, only used if</span>
<span class="sd">            boundaries = &#39;zoom&#39;.</span>
<span class="sd">        scaletype (str): Type of scale for plotting, &#39;continuous&#39; or &#39;binned&#39;.</span>
<span class="sd">            Will be reflected in colorbar.</span>
<span class="sd">        lims (*): None or Nx1 list of tuples or numpy arrays corresponding to</span>
<span class="sd">            plotorder defining the limits for saturating the colorbar</span>
<span class="sd">            (vmin, vmax) if scaletype is continuous or the bins to use (clev)</span>
<span class="sd">            if scaletype if binned. The list can contain tuples, arrays, and</span>
<span class="sd">            Nones, e.g.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                [(0., 10.), None, (0.1, 1.5), np.linspace(0., 1.5, 15)]</span>

<span class="sd">            When None is specified, the program will</span>
<span class="sd">            estimate the limits, when an array is specified but the scale</span>
<span class="sd">            type is continuous, vmin will be set to min(array) and vmax will</span>
<span class="sd">            be set to max(array).</span>
<span class="sd">        logscale (*): boolean to apply log colorbar to all plotted layers or list</span>
<span class="sd">            of booleans corresponding to each layer in grid.</span>
<span class="sd">        ALPHA (float): Transparency for mapping, if there is a hillshade that</span>
<span class="sd">            will plot below each layer, it is recommended to set this to at</span>
<span class="sd">            least 0.7.</span>
<span class="sd">        maproads (bool): Whether to show roads or not, default True, but</span>
<span class="sd">            requires that roadfile is specified and valid to work.</span>
<span class="sd">        mapcities (bool): Whether to show cities or not, default True, but</span>
<span class="sd">            requires that cityfile is specified and valid to work.</span>
<span class="sd">        isScenario (bool): Whether this is a scenario (True) or a real event</span>
<span class="sd">            (False) (default False).</span>
<span class="sd">        roadfolder (str): Full file path to folder containing road shapefiles.</span>
<span class="sd">        topofile (str): Path to topography grid (GDAL compatible). This is</span>
<span class="sd">            only needed to make a hillshade if a premade hillshade is not</span>
<span class="sd">            specified.</span>
<span class="sd">        cityfile (str): Path to Pager file containing city &amp; population</span>
<span class="sd">            information.</span>
<span class="sd">        oceanfile (str): Path to file ocean information.</span>
<span class="sd">        roadcolor (str): Color to use for roads, if plotted, default is</span>
<span class="sd">            &#39;#6E6E6E&#39;.</span>
<span class="sd">        watercolor (str): Color to use for oceans, lakes, and rivers, default</span>
<span class="sd">            is &#39;#B8EEFF&#39;.</span>
<span class="sd">        countrycolor (str): Color for country borders, default is &#39;#177F10&#39;.</span>
<span class="sd">        outputdir (str): Path for output figures, if edict is defined, a</span>
<span class="sd">            subfolder based on the event id will be created in this folder.</span>
<span class="sd">            If None, will use current directory.</span>
<span class="sd">        outfilename (str): Output file name.</span>
<span class="sd">        savepdf (bool): True to save pdf figure.</span>
<span class="sd">        savepng (bool): True to save png figure.</span>
<span class="sd">        showplots (bool): True to display plots</span>
<span class="sd">        printparam (bool): Show parameter values used to run model on plots.</span>
<span class="sd">        ds (bool): True to allow downsampling for display (necessary when</span>
<span class="sd">            arrays are quite large, False to not allow).</span>
<span class="sd">        dstype (str): What function to use in downsampling? Options are &#39;min&#39;,</span>
<span class="sd">            &#39;max&#39;, &#39;median&#39;, or &#39;mean&#39;.</span>
<span class="sd">        upsample (bool): True to upsample the layer to the DEM resolution for</span>
<span class="sd">            better looking hillshades.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (newgrids, filenames), where:</span>
<span class="sd">            * newgrids: list of downsampled and trimmed version of input grids. If</span>
<span class="sd">                no modification was needed for plotting, this will be identical to grids</span>
<span class="sd">                but without the metadata.</span>
<span class="sd">            * filenames: a list of filenames that were created</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO:</span>
    <span class="c1">#     - Change so that all input layers do not have to have the same bounds,</span>
    <span class="c1">#       test plotting multiple probability layers, and add option so that if</span>
    <span class="c1">#       PDF and PNG aren&#39;t output, opens plot on screen using plt.show().</span>

    <span class="k">if</span> <span class="n">suptitle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suptitle</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># display fig only if static fig not output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">showplots</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">savepdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">savepng</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

    <span class="n">defaultcolormap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span>

    <span class="k">if</span> <span class="n">shakefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getEventDict</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getShakeDict</span><span class="p">()</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_id&#39;</span><span class="p">]</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get output file location</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output location given, using current directory &#39;</span>
              <span class="s1">&#39;for outputs</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">outputdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>

    <span class="c1"># Get plotting order, if not specified</span>
    <span class="k">if</span> <span class="n">plotorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotorder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">colormaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>

    <span class="c1"># Get boundaries to use for all plots</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">boundaries</span> <span class="o">==</span> <span class="s1">&#39;zoom&#39;</span><span class="p">:</span>
        <span class="c1"># Find probability layer (will just take the maximum bounds if there is</span>
        <span class="c1"># more than one)</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keytemp</span> <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not find model layer to use for zoom, using &#39;</span>
                  <span class="s1">&#39;default boundaries&#39;</span><span class="p">)</span>
            <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lonmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e10</span>
            <span class="n">lonmin</span> <span class="o">=</span> <span class="mf">1.e10</span>
            <span class="n">latmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e10</span>
            <span class="n">latmin</span> <span class="o">=</span> <span class="mf">1.e10</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                <span class="c1"># get lat lons of areas affected and add, if no areas affected,</span>
                <span class="c1"># switch to shakemap boundaries</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
                <span class="c1"># backwards so it plots right</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">zthresh</span><span class="p">))</span>
                <span class="n">lonmin</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">lonmax</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">latmin</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">latmax</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># dummy fillers, only really care about bounds</span>
            <span class="n">boundaries1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span> <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
            <span class="c1"># Add padding around zoom limits</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">lonmin</span><span class="o">-</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmin</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmin</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">lonmax</span><span class="o">+</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmax</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax</span>
            <span class="k">if</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">latmin</span><span class="o">-</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmin</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymin</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">latmax</span><span class="o">+</span><span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">):</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmax</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundaries1</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymax</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">(</span><span class="n">boundaries1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># SEE IF BOUNDARIES ARE SAME AS BOUNDARIES OF LAYERS</span>
        <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tempgdict</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tempgdict</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are almost the same as specified &#39;</span>
                  <span class="s1">&#39;boundaries, no cutting needed&#39;</span><span class="p">)</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">tempgdict</span>
            <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are not usable, using &#39;</span>
                          <span class="s1">&#39;default boundaries&#39;</span><span class="p">)</span>
                    <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Build dummy GeoDict</span>
                    <span class="n">boundaries</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">boundaries</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                                          <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">},</span>
                                         <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input boundaries are not usable, using default &#39;</span>
                      <span class="s1">&#39;boundaries&#39;</span><span class="p">)</span>
                <span class="n">keytemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">boundaries</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">keytemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Pull out bounds for various uses</span>
    <span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span>
                                  <span class="n">boundaries</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>

    <span class="c1"># Determine if need a single panel or multi-panel plot and if multi-panel,</span>
    <span class="c1"># how many and how it will be arranged</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">numpanels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># create the figure and axes instances.</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">numpanels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numpanels</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rowpan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numpanels</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">colpan</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">rowpan</span><span class="o">*</span><span class="mf">6.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">rowpan</span><span class="o">*</span><span class="mf">5.3</span><span class="p">)</span>

    <span class="n">fontsizemain</span> <span class="o">=</span> <span class="mf">14.</span>
    <span class="n">fontsizesub</span> <span class="o">=</span> <span class="mf">12.</span>
    <span class="n">fontsizesmallest</span> <span class="o">=</span> <span class="mf">10.</span>
    <span class="k">if</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">fontsizemain</span> <span class="o">=</span> <span class="mf">12.</span>
        <span class="n">fontsizesub</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="n">fontsizesmallest</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isScenario</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timestr</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b </span><span class="si">%d</span><span class="s1"> %Y&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;M</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> v</span><span class="si">%i</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                                           <span class="n">timestr</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
                                           <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizemain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizemain</span><span class="p">)</span>

    <span class="n">clear_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># Cut all of them and release extra memory</span>
    <span class="n">xbuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
    <span class="n">ybuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span>
    <span class="n">cutxmin</span> <span class="o">=</span> <span class="n">bxmin</span><span class="o">-</span><span class="n">xbuff</span>
    <span class="n">cutymin</span> <span class="o">=</span> <span class="n">bymin</span><span class="o">-</span><span class="n">ybuff</span>
    <span class="n">cutxmax</span> <span class="o">=</span> <span class="n">bxmax</span><span class="o">+</span><span class="n">xbuff</span>
    <span class="n">cutymax</span> <span class="o">=</span> <span class="n">bymax</span><span class="o">+</span><span class="n">ybuff</span>
    <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">newgrids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="n">templayer</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">templayer</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutxmax</span><span class="p">,</span>
                                          <span class="n">cutymin</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Cutting failed, </span><span class="si">%s</span><span class="s1">, continuing with full layers&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">newgrids</span> <span class="o">=</span> <span class="n">grids</span>
                <span class="k">continue</span>
        <span class="k">del</span> <span class="n">templayer</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newgrids</span> <span class="o">=</span> <span class="n">grids</span>
    <span class="n">tempgdict</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>

    <span class="c1"># Upsample layers to same as topofile if desired for better looking</span>
    <span class="c1"># hillshades</span>
    <span class="k">if</span> <span class="n">upsample</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">topofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topodict</span> <span class="o">=</span> <span class="n">GDALGrid</span><span class="o">.</span><span class="n">getFileGeoDict</span><span class="p">(</span><span class="n">topofile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">dx</span> <span class="ow">or</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">dy</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upsampling not possible, resolution of results &#39;</span>
                      <span class="s1">&#39;already smaller than DEM&#39;</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tempgdict1</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="n">xbuff</span><span class="p">,</span>
                                      <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="n">ybuff</span><span class="p">,</span>
                                      <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">xmax</span><span class="o">+</span><span class="n">xbuff</span><span class="p">,</span>
                                      <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">tempgdict</span><span class="o">.</span><span class="n">ymax</span><span class="o">+</span><span class="n">ybuff</span><span class="p">,</span>
                                      <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                                      <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
                                      <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span>
                                      <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="n">topodict</span><span class="o">.</span><span class="n">ny</span><span class="p">},</span>
                                     <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
                <span class="n">tempgdict2</span> <span class="o">=</span> <span class="n">tempgdict1</span><span class="o">.</span><span class="n">getBoundsWithin</span><span class="p">(</span><span class="n">tempgdict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                    <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">subdivide</span><span class="p">(</span><span class="n">tempgdict2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upsampling failed, continuing&#39;</span><span class="p">)</span>

    <span class="c1"># Downsample all of them for plotting, if needed, and replace them in</span>
    <span class="c1"># grids (to save memory)</span>
    <span class="n">tempgrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span>
    <span class="n">inchesx</span><span class="p">,</span> <span class="n">inchesy</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()</span>
    <span class="n">divx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xsize</span><span class="o">/</span><span class="p">(</span><span class="mf">500.</span><span class="o">*</span><span class="n">inchesx</span><span class="p">)))</span>
    <span class="n">divy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ysize</span><span class="o">/</span><span class="p">(</span><span class="mf">500.</span><span class="o">*</span><span class="n">inchesy</span><span class="p">)))</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">gdict</span> <span class="o">=</span> <span class="n">tempgrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>  <span class="c1"># Will be replaced if downsampled</span>
    <span class="k">del</span> <span class="n">tempgrid</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">divx</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">divy</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">divx</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">divy</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span>
        <span class="k">elif</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span>
        <span class="k">elif</span> <span class="n">dstype</span> <span class="o">==</span> <span class="s1">&#39;med&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="n">layergrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">layergrid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                               <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divy</span><span class="p">,</span> <span class="n">divx</span><span class="p">),</span>
                               <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                               <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span>
                                                <span class="n">layergrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span>
                                    <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divx</span><span class="p">,),</span>
                                    <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                                    <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span>
                                                <span class="n">layergrid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span><span class="o">.</span><span class="n">ny</span><span class="p">),</span>
                                    <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="n">divy</span><span class="p">,),</span>
                                    <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                                    <span class="n">cval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">gdict</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">({</span><span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                 <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                 <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                 <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                 <span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span>
                                 <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)},</span>
                                <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
            <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">gdict</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">layergrid</span><span class="p">,</span> <span class="n">dat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xsize</span><span class="p">)</span>
        <span class="c1"># backwards so it plots right side up</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ysize</span><span class="p">)</span>

    <span class="c1"># make meshgrid</span>
    <span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>

    <span class="c1"># See if there is an oceanfile for masking</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">PolygonSH</span><span class="p">(((</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutymin</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmin</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmax</span><span class="p">,</span> <span class="n">cutymax</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">cutxmax</span><span class="p">,</span> <span class="n">cutymin</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">oceanfile</span><span class="p">)</span>
            <span class="n">oc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">oc</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="c1"># make boundaries into a shape</span>
            <span class="n">ocean</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not able to read specified ocean file, will use default &#39;</span>
                  <span class="s1">&#39;ocean masking&#39;</span><span class="p">)</span>
            <span class="n">oceanfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inventory_shapefile</span><span class="p">)</span>
            <span class="n">invshp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymax</span><span class="p">)))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">inventory</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">invshp</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unable to read inventory shapefile specified, will not &#39;</span>
                  <span class="s1">&#39;plot inventory&#39;</span><span class="p">)</span>
            <span class="n">inventory_shapefile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Find cities that will be plotted</span>
    <span class="k">if</span> <span class="n">mapcities</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">cityfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mycity</span> <span class="o">=</span> <span class="n">BasemapCities</span><span class="o">.</span><span class="n">loadFromGeoNames</span><span class="p">(</span><span class="n">cityfile</span><span class="o">=</span><span class="n">cityfile</span><span class="p">)</span>
            <span class="n">bcities</span> <span class="o">=</span> <span class="n">mycity</span><span class="o">.</span><span class="n">limitByBounds</span><span class="p">((</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span><span class="p">))</span>
            <span class="n">bcities</span> <span class="o">=</span> <span class="n">bcities</span><span class="o">.</span><span class="n">limitByGrid</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cities_per_grid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not read in cityfile, not plotting cities&#39;</span><span class="p">)</span>
            <span class="n">mapcities</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cityfile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Load in topofile</span>
    <span class="k">if</span> <span class="n">topofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topomap</span> <span class="o">=</span> <span class="n">GDALGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">topofile</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                    <span class="n">samplegeodict</span><span class="o">=</span><span class="n">gdict</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">topomap</span> <span class="o">=</span> <span class="n">GMTGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">topofile</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                   <span class="n">samplegeodict</span><span class="o">=</span><span class="n">gdict</span><span class="p">)</span>
        <span class="n">topodata</span> <span class="o">=</span> <span class="n">topomap</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># mask oceans if don&#39;t have ocean shapefile</span>
        <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">topodata</span> <span class="o">=</span> <span class="n">maskoceans</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">,</span> <span class="n">topodata</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                                  <span class="n">grid</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">inlands</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no hillshade is possible</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">topomap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">topodata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Load in roads, if needed</span>
    <span class="n">roadslist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">maproads</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">roadfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roadslist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">roadfolder</span><span class="p">):</span>
                <span class="n">road1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roadfolder</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
                <span class="n">shpfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">road1</span><span class="p">,</span> <span class="s1">&#39;*.shp&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shpfiles</span><span class="p">):</span>
                    <span class="n">shpfile</span> <span class="o">=</span> <span class="n">shpfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shpfile</span><span class="p">)</span>
                    <span class="n">shapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bymin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="n">bymax</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">shapeid</span><span class="p">,</span> <span class="n">shapedict</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
                        <span class="n">roadslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapedict</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not able to plot roads&#39;</span><span class="p">)</span>

    <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
        <span class="n">layergrid</span> <span class="o">=</span> <span class="n">newgrids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">layer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">rowpan</span><span class="p">,</span> <span class="n">colpan</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">clat</span> <span class="o">=</span> <span class="n">bymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">clon</span> <span class="o">=</span> <span class="n">bxmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="c1"># setup of basemap (&#39;lcc&#39; = lambert conformal conic, or tmerc</span>
        <span class="c1"># is transverse mercator).</span>
        <span class="c1"># use major and minor sphere radii from WGS84 ellipsoid.</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">bymin</span><span class="p">,</span>
                    <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">bxmax</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">bymax</span><span class="p">,</span>
                    <span class="n">rsphere</span><span class="o">=</span><span class="p">(</span><span class="mf">6378137.00</span><span class="p">,</span> <span class="mf">6356752.3142</span><span class="p">),</span>
                    <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">area_thresh</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;tmerc&#39;</span><span class="p">,</span>
                    <span class="n">lat_0</span><span class="o">=</span><span class="n">clat</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">clon</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">)</span>  <span class="c1"># get projection coordinates</span>
        <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wid</span><span class="p">,</span> <span class="n">ht</span> <span class="o">=</span> <span class="n">axsize</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">axsize</span><span class="o">.</span><span class="n">height</span>
        <span class="n">default1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colormaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">default1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Find preferred default color map for each type of layer if no</span>
        <span class="c1"># colormaps found</span>
        <span class="k">if</span> <span class="n">default1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prob&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;pga&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="s1">&#39;pgv&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;cohesion&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="s1">&#39;friction&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;fs&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span>
            <span class="k">elif</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">gnuplot2</span>
            <span class="k">elif</span> <span class="s1">&#39;precip&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">cm2</span><span class="o">.</span><span class="n">s3pcpn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">palette</span> <span class="o">=</span> <span class="n">defaultcolormap</span>

        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ptopo</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">transform_scalar</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">topodata</span><span class="p">),</span> <span class="n">lons</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                    <span class="n">lats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">wid</span><span class="p">)),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">ht</span><span class="p">)),</span> <span class="n">returnxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkbounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># use lightsource class to make our shaded topography</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">135</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">ls1</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">ls2</span> <span class="o">=</span> <span class="n">LightSource</span><span class="p">(</span><span class="n">azdeg</span><span class="o">=</span><span class="mi">225</span><span class="p">,</span> <span class="n">altdeg</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">intensity1</span> <span class="o">=</span> <span class="n">ls1</span><span class="o">.</span><span class="n">hillshade</span><span class="p">(</span><span class="n">ptopo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vert_exag</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">intensity2</span> <span class="o">=</span> <span class="n">ls2</span><span class="o">.</span><span class="n">hillshade</span><span class="p">(</span><span class="n">ptopo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vert_exag</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity1</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">intensity2</span><span class="o">*</span><span class="mf">0.5</span>

        <span class="c1"># Get the data</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">layergrid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># mask out anything below any specified thresholds</span>

        <span class="c1"># if logscale is not False and len(logscale) == len(plotorder):</span>
        <span class="c1">#     if logscale[k] is True:</span>
        <span class="c1">#         dat = np.log10(dat)</span>
        <span class="c1">#         label1 = r&#39;$log_{10}$(&#39; + label1 + &#39;)&#39;</span>

        <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span>
                                           <span class="mf">0.25</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find order of range to know how to scale</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">order</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mf">1.</span>

                    <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                                <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clev</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find order of range to know how to scale</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">scal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">order</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scal</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                        <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">10</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Adjust to colorbar levels</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span> <span class="o">&gt;=</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="c1"># So colorbar saturates at top</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logscale</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="c1"># Put it in a list so it won&#39;t break things later</span>
                <span class="n">logscale</span> <span class="o">=</span> <span class="p">[</span><span class="n">logscale</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

        <span class="c1"># Might need to move this up to before downsampling...</span>
        <span class="c1"># might give illusion of no hazard in places where there is some that</span>
        <span class="c1"># just got averaged out.</span>
        <span class="k">if</span> <span class="n">maskthreshes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskthreshes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;=</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>

        <span class="c1"># Mask out cells overlying oceans or block with a shapefile if</span>
        <span class="c1"># available</span>
        <span class="k">if</span> <span class="n">oceanfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">maskoceans</span><span class="p">(</span><span class="n">llons1</span><span class="p">,</span> <span class="n">llats1</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                             <span class="n">grid</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">inlands</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ocean</span><span class="p">)</span> <span class="ow">is</span> <span class="n">PolygonSH</span><span class="p">:</span>
                <span class="n">ocean</span> <span class="o">=</span> <span class="p">[</span><span class="n">ocean</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">ocean</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">getProjectedPatch</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#006280&quot;</span><span class="p">,</span>
                                          <span class="n">facecolor</span><span class="o">=</span><span class="n">watercolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                          <span class="n">zorder</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">in1</span> <span class="ow">in</span> <span class="n">inventory</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;point&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">in1</span><span class="p">)):</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">in1</span><span class="o">.</span><span class="n">xy</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                              <span class="n">zorder</span><span class="o">=</span><span class="mi">100001</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">in1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                    <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">clear_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># Plot it up</span>
        <span class="n">dat_im</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">transform_scalar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span>
                                    <span class="n">lons</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                                    <span class="n">lats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">gdict</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">wid</span><span class="p">)),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">300.</span><span class="o">*</span><span class="n">ht</span><span class="p">)),</span>
                                    <span class="n">returnxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">checkbounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logscale</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logsc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Drape over hillshade</span>
        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># turn data into an RGBA image</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">palette</span>
            <span class="c1"># adjust data so scaled between vmin and vmax and between 0 and 1</span>
            <span class="n">dat1</span> <span class="o">=</span> <span class="n">dat_im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dat1</span><span class="p">[</span><span class="n">dat1</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">dat1</span><span class="p">[</span><span class="n">dat1</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>
            <span class="n">dat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat1</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span>
            <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">dat1</span><span class="p">)</span>
            <span class="n">maskvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">dat1</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rgba_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">rgb</span><span class="p">[</span><span class="n">maskvals</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">draped_hsv</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">blend_hsv</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">draped_hsv</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>
            <span class="c1"># This is just a dummy layer that will be deleted to make the</span>
            <span class="c1"># colorbar look right</span>
            <span class="n">panelhandle</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dat_im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">,</span>
                                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panelhandle</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dat_im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">,</span>
                                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cbfmt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">vmax</span> <span class="o">&gt;</span> <span class="mf">5.</span><span class="p">:</span>  <span class="c1"># (vmax - vmin) &gt; len(clev):</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">panelhandle</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;proportional&#39;</span><span class="p">,</span>
                                <span class="n">ticks</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.036</span><span class="p">,</span>
                                <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                                <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">panelhandle</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.036</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                                <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">logsc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">topodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">panelhandle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">parallels</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">getMapLines</span><span class="p">(</span><span class="n">bymin</span><span class="p">,</span> <span class="n">bymax</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">labelstyle</span><span class="o">=</span><span class="s1">&#39;+/-&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">xoffset</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">100.</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">getMapLines</span><span class="p">(</span><span class="n">bxmin</span><span class="p">,</span> <span class="n">bxmax</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">labelstyle</span><span class="o">=</span><span class="s1">&#39;+/-&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">100.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">parallels</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parallels</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># draw roads on the map, if they were provided to us</span>
        <span class="k">if</span> <span class="n">maproads</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">roadslist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">road</span> <span class="ow">in</span> <span class="n">roadslist</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">road</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">])</span>
                        <span class="n">roadx</span><span class="p">,</span> <span class="n">roady</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">))</span>
                        <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">roadx</span><span class="p">,</span> <span class="n">roady</span><span class="p">)</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span><span class="p">,</span> <span class="n">roadcolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Failed to plot roads, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># add city names to map</span>
        <span class="k">if</span> <span class="n">mapcities</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">cityfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="c1"># Only need to choose cities first time and then apply to rest</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fcities</span> <span class="o">=</span> <span class="n">bcities</span><span class="o">.</span><span class="n">limitByMapCollision</span><span class="p">(</span>
                        <span class="n">m</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="n">ctlats</span><span class="p">,</span> <span class="n">ctlons</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">fcities</span><span class="o">.</span><span class="n">getCities</span><span class="p">()</span>
                    <span class="n">cxis</span><span class="p">,</span> <span class="n">cyis</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">ctlons</span><span class="p">,</span> <span class="n">ctlats</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ctlat</span><span class="p">,</span> <span class="n">ctlon</span><span class="p">,</span> <span class="n">cxi</span><span class="p">,</span> <span class="n">cyi</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> \
                        <span class="nb">zip</span><span class="p">(</span><span class="n">ctlats</span><span class="p">,</span> <span class="n">ctlons</span><span class="p">,</span> <span class="n">cxis</span><span class="p">,</span> <span class="n">cyis</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ctlon</span><span class="p">,</span> <span class="n">ctlat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                              <span class="n">zorder</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cxi</span><span class="p">,</span> <span class="n">cyi</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to plot cities, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># draw star at epicenter</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">elat</span><span class="p">,</span> <span class="n">elon</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
            <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">elon</span><span class="p">,</span> <span class="n">elat</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">10000.</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">drawmapboundary</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">fillcontinents</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">clear_color</span><span class="p">,</span> <span class="n">lake_color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawrivers</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">watercolor</span><span class="p">)</span>

        <span class="c1"># draw country boundaries</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawcountries</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">countrycolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># add map scale</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">((</span><span class="n">bxmax</span><span class="o">+</span><span class="n">bxmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">bymin</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">bymax</span><span class="o">-</span><span class="n">bymin</span><span class="p">)),</span> <span class="n">clon</span><span class="p">,</span> <span class="n">clat</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((((</span><span class="n">bxmax</span><span class="o">-</span><span class="n">bxmin</span><span class="p">)</span><span class="o">*</span><span class="mi">111</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">barstyle</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Add border</span>
        <span class="n">autoAxis</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
                         <span class="n">autoAxis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">autoAxis</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mf">0.4</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mf">1e8</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">source: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">sref</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">label1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizesub</span><span class="p">)</span>

        <span class="c1"># draw scenario watermark, if scenario</span>
        <span class="k">if</span> <span class="n">isScenario</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">clon</span><span class="p">,</span> <span class="n">clat</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="s1">&#39;SCENARIO&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="c1"># if ds: # Could add this to print &quot;downsampled&quot; on map</span>
        <span class="c1">#     plt.text()</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rowpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># adjust single level plot</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
            <span class="n">ht2</span> <span class="o">=</span> <span class="n">axsize</span><span class="o">.</span><span class="n">height</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">ht2</span><span class="o">*</span><span class="mf">1.6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Make room for suptitle - tight layout doesn&#39;t account for it</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">printparam</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
            <span class="n">paramstring</span> <span class="o">=</span> <span class="s1">&#39;Model parameters: &#39;</span>
            <span class="n">halfway</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">halfway</span> <span class="ow">and</span> <span class="n">colpan</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">paramstring</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">paramstring</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">paramstring</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">paramstring</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsizesmallest</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not display model parameters&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eventid</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eventid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">outfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y_%H%M&#39;</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pdf&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">eventid</span><span class="p">,</span> <span class="n">suptitle</span><span class="p">,</span> <span class="n">time1</span><span class="p">))</span>
        <span class="n">pngfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.png&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">eventid</span><span class="p">,</span> <span class="n">suptitle</span><span class="p">,</span> <span class="n">time1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">outfilename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">pngfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">outfilename</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">savepdf</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving map output to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">savepng</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving map output to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pngfile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showplots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newgrids</span><span class="p">,</span> <span class="n">filenames</span></div>


<div class="viewcode-block" id="interactiveMap"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.interactiveMap">[docs]</a><span class="k">def</span> <span class="nf">interactiveMap</span><span class="p">(</span><span class="n">grids</span><span class="p">,</span> <span class="n">shakefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plotorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">inventory_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskthreshes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">scaletype</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">ALPHA</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">isScenario</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">outfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tiletype</span><span class="o">=</span><span class="s1">&#39;Stamen Terrain&#39;</span><span class="p">,</span>
                   <span class="n">smcontourfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">faultfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">onkey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sepcolorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">floatcb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">savefiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mapid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates interactive html plots of mapio grid layers</span>
<span class="sd">    (e.g. liquefaction or landslide models with their input layers).</span>

<span class="sd">    Args:</span>
<span class="sd">        grids (dict): Dictionary of N layers and metadata formatted like:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                maplayers[&#39;layer name&#39;]=</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;grid&#39;: mapio grid2D object,</span>
<span class="sd">                    &#39;label&#39;: &#39;label for colorbar and top line of subtitle&#39;,</span>
<span class="sd">                    &#39;type&#39;: &#39;output or input to model&#39;,</span>
<span class="sd">                    &#39;description&#39;: &#39;detailed description for subtitle&#39;</span>
<span class="sd">                }</span>

<span class="sd">            Layer names must be unique.</span>
<span class="sd">        shakefile (str): Optional ShakeMap file (url or full file path) to</span>
<span class="sd">            extract information for labels and folder names.</span>
<span class="sd">        plotorder (list): List of keys describing the order to plot the grids,</span>
<span class="sd">            if None and grids is an ordered dictionary, it will use the order</span>
<span class="sd">            of the dictionary, otherwise it will choose order which may be</span>
<span class="sd">            somewhat random but it will always put a probability grid first.</span>
<span class="sd">        inventory_shapefile (str): Optional path to inventory file.</span>
<span class="sd">        maskthreshes (array): N x 1 array or list of lower thresholds for</span>
<span class="sd">            masking corresponding to order in plotorder or order of OrderedDict</span>
<span class="sd">            if plotorder is None. If grids is not an ordered dict and plotorder</span>
<span class="sd">            is not specified, this will not work right. If None (default),</span>
<span class="sd">            nothing will be masked.</span>
<span class="sd">        colormaps (list): List of strings of matplotlib colormaps</span>
<span class="sd">            (e.g. cm.autumn_r) corresponding to plotorder or order of</span>
<span class="sd">            dictionary if plotorder is None. The list can contain both strings</span>
<span class="sd">            and None e.g. colormaps = [&#39;cm.autumn&#39;, None, None, &#39;cm.jet&#39;] and</span>
<span class="sd">            None&#39;s will default to default colormap.</span>
<span class="sd">        scaletype (str): Type of scale for plotting, &#39;continuous&#39; or &#39;binned&#39;.</span>
<span class="sd">            Will be reflected in colorbar.</span>
<span class="sd">        lims (list): None or Nx1 list of tuples or numpy arrays corresponding</span>
<span class="sd">            to plotorder defining the limits for saturating the colorbar</span>
<span class="sd">            (vmin, vmax) if scaletype is continuous or the bins to use (clev)</span>
<span class="sd">            if scaletype if binned. The list can contain tuples, arrays, and</span>
<span class="sd">            Nones, e.g. lims = [(0., 10.), None, (0.1, 1.5),</span>
<span class="sd">            np.linspace(0., 1.5, 15)]. When None is specified, the program will</span>
<span class="sd">            estimate the limits, when an array is specified but the scale</span>
<span class="sd">            type is continuous, vmin will be set to min(array) and vmax will</span>
<span class="sd">            be set to max(array).</span>
<span class="sd">        logscale (list): None, single boolean value, or Nx1 list of booleans</span>
<span class="sd">            defining whether to use a log scale or not for each layer.</span>
<span class="sd">        alpha (float): Transparency for mapping, if there is a hillshade that</span>
<span class="sd">            will plot below each layer, it is recommended to set this to at</span>
<span class="sd">            least 0.7.</span>
<span class="sd">        isScenario (bool): Is this a scenario?</span>
<span class="sd">        outputdir (str): File path for outputting figures, if edict is defined,</span>
<span class="sd">            a subfolder based on the event id will be created in this folder.</span>
<span class="sd">            If None, will use current directory.</span>
<span class="sd">        outfilename (str): File name for output (without any file extensions).</span>
<span class="sd">        tiletype (str): Folium tile type:</span>
<span class="sd">            - &quot;OpenStreetMap&quot;</span>
<span class="sd">            - &quot;Mapbox Bright&quot; (Limited levels of zoom for free tiles)</span>
<span class="sd">            - &quot;Mapbox Control Room&quot; (Limited levels of zoom for free tiles)</span>
<span class="sd">            - &quot;Stamen&quot; (Terrain, Toner, and Watercolor)</span>
<span class="sd">            - &quot;Cloudmade&quot; (Must pass API key)</span>
<span class="sd">            - &quot;Mapbox&quot; (Must pass API key)</span>
<span class="sd">            - &quot;CartoDB&quot; (positron and dark_matter)</span>
<span class="sd">        separate (bool): If True, will make a separate html file for each map</span>
<span class="sd">            (default), if False, all layers will be on same map.</span>
<span class="sd">        onkey (str): If separate=False, key of model layer that should be the</span>
<span class="sd">            active layer initially. If None (default), the first model will be</span>
<span class="sd">            on by default.</span>
<span class="sd">        sepcolorbar (bool): If True, will make separate colorbar figure,</span>
<span class="sd">            if False (default), will embed simple colorbar</span>
<span class="sd">        floatcb (bool): If True (default) and sepcolobar is True, will float</span>
<span class="sd">            the colorbar on the map.</span>
<span class="sd">        savefiles(bool): If True (default), will save map as html file,</span>
<span class="sd">            otherwise will just return map object</span>
<span class="sd">        mapid (str): map id, used only for syncing two of these interactive maps</span>
<span class="sd">            to each other</span>
<span class="sd">        clear_zero (bool): If True, will make all zero values clear.</span>
<span class="sd">            default is False.</span>
<span class="sd">        sync: If False, each map will use it&#39;s own colorbar.</span>
<span class="sd">            If a grid layer shortref is specified (e.g. &#39;Nowicki and others (2014)&#39;),</span>
<span class="sd">            all maps will have colorbars synced to the colors of the one</span>
<span class="sd">            specified, but they must all have the same number of bins</span>

<span class="sd">    Returns:</span>
<span class="sd">        * Interactive plot (html file) of all grids listed in plotorder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">separate</span> <span class="ow">and</span> <span class="n">sepcolorbar</span><span class="p">:</span>
        <span class="n">sepcolorbar</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="n">clear_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plotorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">grids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">plotorder</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotorder</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">logscale</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">logscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">logscale</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length of lims not equal to length of plotorder,</span><span class="se">\</span>
<span class="s1">              setting lims as None for all layers&#39;</span><span class="p">)</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">maskthreshes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maskthreshes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">maskthreshes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length of maskthreshes not equal to length of plotorder,</span><span class="se">\</span>
<span class="s1">              setting maskthreshes as None for all layers&#39;</span><span class="p">)</span>
        <span class="n">maskthreshes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>

    <span class="n">defaultcolormap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span>

    <span class="k">if</span> <span class="n">colormaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">defaultcolormap</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length of colormaps not equal to length of plotorder,</span><span class="se">\</span>
<span class="s1">              setting colormaps to default or </span><span class="si">%s</span><span class="s1"> for all layers&#39;</span> <span class="o">%</span> <span class="n">defaultcolormap</span><span class="p">)</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">defaultcolormap</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">shakefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getEventDict</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakefile</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getShakeDict</span><span class="p">()</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;eventid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_id&#39;</span><span class="p">]</span>
        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;scenario&#39;</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;shakemap_event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">isScenario</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">edict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get output file location</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output location given, using current directory &#39;</span>
              <span class="s1">&#39;for outputs</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">outputdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfolder</span> <span class="o">=</span> <span class="n">outputdir</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>

    <span class="c1">#TODO ADD IN DOWNSAMPLING CODE FROM MODELMAP HERE - OR CREATE TILES?</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cbars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">removelater</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get reference colorbar, if specified</span>
    <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
        <span class="n">sync</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">reflims</span> <span class="o">=</span> <span class="n">setupsync</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">plotorder</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="n">colormaps</span><span class="p">,</span>
                                             <span class="n">defaultcolormap</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="n">logscale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sepcolorbar</span><span class="p">:</span>
                <span class="n">sepcolorbar</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Changing to separate colorbar, embedded colorbar not implemented for sync&#39;</span><span class="p">)</span>
            <span class="n">scaletype</span> <span class="o">=</span> <span class="s1">&#39;binned&#39;</span>  <span class="c1"># scaletype has to be binned for sync</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reflims</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">):</span>

        <span class="c1"># Get simplified name of key for file naming</span>
        <span class="n">RIDOF</span> <span class="o">=</span> <span class="s1">&#39;[+-]?(?=\d*[.eE])(?=\.?\d)\d*\.?\d*(?:[eE][+-]?\d+)?&#39;</span>
        <span class="n">OPERATORPAT</span> <span class="o">=</span> <span class="s1">&#39;[\+\-\*\/]*&#39;</span>
        <span class="n">keyS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">OPERATORPAT</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1"># remove floating point numbers</span>
        <span class="n">keyS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RIDOF</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">keyS</span><span class="p">)</span>
        <span class="c1"># remove parentheses</span>
        <span class="n">keyS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[()]*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">keyS</span><span class="p">)</span>
        <span class="c1"># remove any blank spaces</span>
        <span class="n">keyS</span> <span class="o">=</span> <span class="n">keyS</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>

        <span class="c1"># get labels and metadata info</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">sref_fix</span> <span class="o">=</span> <span class="n">sref</span>
        <span class="k">if</span> <span class="n">sref</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">sref_fix</span> <span class="o">=</span> <span class="n">sref_fix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; (&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">sref_fix</span> <span class="o">=</span> <span class="n">sref_fix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">sref_fix</span> <span class="o">=</span> <span class="n">sref_fix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outfilename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfilename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">],</span> <span class="n">sref_fix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">outfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfilename</span> <span class="o">=</span> <span class="n">sref_fix</span>

        <span class="k">if</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">defaultcolormap</span>

        <span class="n">palette</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">clear_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">dat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clear_zero</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>  <span class="c1"># Makes areas clear where dat==0</span>

        <span class="k">if</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;=</span> <span class="n">maskthreshes</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>

        <span class="c1"># Make changes needed to get desired colorbar</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">correct4colorbar</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">scaletype</span><span class="p">,</span>
                                   <span class="n">palette</span><span class="p">,</span> <span class="n">colorlist</span><span class="o">=</span><span class="n">colorlist</span><span class="p">)</span>
        <span class="n">clev</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">rgba_img</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">colorlist</span> <span class="o">=</span> <span class="n">outputs</span>

        <span class="n">gd</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">getGeoDict</span><span class="p">()</span>
        <span class="n">minlat</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">gd</span><span class="o">.</span><span class="n">dy</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">minlon</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">gd</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">maxlat</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">ymax</span> <span class="o">+</span> <span class="n">gd</span><span class="o">.</span><span class="n">dy</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">maxlon</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">xmax</span> <span class="o">+</span> <span class="n">gd</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="mf">2.</span>

        <span class="c1"># Make colorbar figure</span>
        <span class="k">if</span> <span class="n">sepcolorbar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.3f</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.1f</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">vmax</span> <span class="o">&gt;=</span> <span class="mf">5.</span><span class="p">:</span>  <span class="c1"># (vmax - vmin) &gt; len(clev):</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>  <span class="c1"># override previous choice if logscale</span>
                <span class="n">cbfmt</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &#39;%1.0e&#39;</span>

            <span class="k">if</span> <span class="n">separate</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">0.9</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
                    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                 <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                                 <span class="n">extendfrac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span>
                                 <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newclev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Modify so colorbar uses full expanse of colorbar</span>
                    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                 <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                                 <span class="n">extendfrac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">newclev</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">newclev</span><span class="p">,</span>
                                 <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;proportional&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                             <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                             <span class="nb">format</span><span class="o">=</span><span class="n">cbfmt</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">clev</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">cbars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">cbars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">sref</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">cbars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
                <span class="n">ctemp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_colorbar.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">keyS</span><span class="p">)</span>
                <span class="c1"># This file has to move with the html files</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">ctemp</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
                <span class="n">ctemp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_colorbar.png&#39;</span> <span class="o">%</span> <span class="n">outfilename</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">ctemp</span><span class="p">),</span>
                            <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">inventory_shapefile</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
            <span class="n">buffer1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">shapeRecords</span><span class="p">():</span>
                <span class="n">atr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">sr</span><span class="o">.</span><span class="n">record</span><span class="p">))</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">__geo_interface__</span>
                <span class="n">style_function</span> <span class="o">=</span> \
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
                <span class="n">buffer1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                                    <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span>
                                    <span class="n">properties</span><span class="o">=</span><span class="n">atr</span><span class="p">))</span>

            <span class="c1"># create geojson object</span>
            <span class="n">invt</span> <span class="o">=</span> <span class="n">GeoJson1</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">buffer1</span><span class="p">},</span>
                            <span class="n">style_function</span><span class="o">=</span><span class="n">style_function</span><span class="p">)</span>

        <span class="n">zoom_start</span> <span class="o">=</span> <span class="n">getZoom</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.</span>

        <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">onkey</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">onkey</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">separate</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="n">onkey</span><span class="p">:</span>
            <span class="n">map1</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="p">[(</span><span class="n">maxlat</span><span class="o">+</span><span class="n">minlat</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">maxlon</span><span class="o">+</span><span class="n">minlon</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span>
                <span class="n">tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">min_lat</span><span class="o">=</span><span class="n">minlat</span><span class="p">,</span>
                <span class="n">max_lat</span><span class="o">=</span><span class="n">maxlat</span><span class="p">,</span>
                <span class="n">min_lon</span><span class="o">=</span><span class="n">minlon</span><span class="p">,</span>
                <span class="n">max_lon</span><span class="o">=</span><span class="n">maxlon</span><span class="p">,</span>
                <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom_start</span><span class="p">,</span>
                <span class="n">max_zoom</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                <span class="n">prefer_canvas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">control_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">(</span>
                <span class="n">tiles</span><span class="o">=</span><span class="n">tiletype</span><span class="p">,</span>
                <span class="n">control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">overlay</span><span class="o">=</span><span class="ow">not</span> <span class="n">overlay</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>

        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">ImageOverlay</span><span class="p">(</span><span class="n">rgba_img</span><span class="p">,</span>
                                           <span class="n">opacity</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span>
                                           <span class="n">bounds</span><span class="o">=</span><span class="p">[[</span><span class="n">minlat</span><span class="p">,</span> <span class="n">minlon</span><span class="p">],</span> <span class="p">[</span><span class="n">maxlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">]],</span>
                                           <span class="n">mercator_project</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">sref</span><span class="p">,</span>
                                           <span class="n">overlay</span><span class="o">=</span><span class="n">overlay</span><span class="p">,</span>
                                           <span class="n">zIndex</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

        <span class="n">images</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>
        <span class="c1"># Save list of layers that should not be visible initially but should be in legend</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">onkey</span> <span class="ow">and</span> <span class="n">separate</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">savefiles</span><span class="p">:</span>
            <span class="n">removelater</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">sepcolorbar</span> <span class="ow">and</span> <span class="n">floatcb</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">plugins</span><span class="o">.</span><span class="n">FloatImage</span><span class="p">(</span><span class="n">ctemp</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">sepcolorbar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
                <span class="n">color1</span> <span class="o">=</span> <span class="n">palette</span><span class="p">(</span><span class="n">clev</span><span class="o">/</span><span class="n">clev</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmb</span><span class="o">.</span><span class="n">StepColormap</span><span class="p">(</span>
                    <span class="n">color1</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">clev</span><span class="p">,</span>
                    <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">sref</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">palette</span><span class="o">.</span><span class="n">_lut</span><span class="p">]</span>
                <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmb</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span>
                    <span class="n">color1</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                    <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">sref</span><span class="p">)))</span>
            <span class="n">map1</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">cbars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">separate</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>

            <span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">(</span>
                <span class="n">collapsed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>
            <span class="n">map1</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">RectangleMarker</span><span class="p">(</span>
                <span class="n">bounds</span><span class="o">=</span><span class="p">[[</span><span class="n">minlat</span><span class="p">,</span> <span class="n">minlon</span><span class="p">],</span> <span class="p">[</span><span class="n">maxlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">]],</span>
                <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
            <span class="n">map1</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">LatLngPopup</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">inventory_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map1</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">invt</span><span class="p">)</span>
                <span class="n">invt</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="s1">&#39;Inventory&#39;</span>

            <span class="k">if</span> <span class="n">smcontourfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">style_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
                <span class="n">GeoJson</span><span class="p">(</span><span class="n">smcontourfile</span><span class="p">,</span> <span class="n">style_function</span><span class="o">=</span><span class="n">style_function</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ShakeMap Contours&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">faultfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">style_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
                <span class="n">GeoJson</span><span class="p">(</span><span class="n">faultfile</span><span class="p">,</span> <span class="n">style_function</span><span class="o">=</span><span class="n">style_function</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Finite fault&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>

            <span class="c1"># Make scenario float image</span>
            <span class="k">if</span> <span class="n">isScenario</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                                            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Scenario&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
                <span class="n">scenfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="s1">&#39;scenario.png&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">scenfile</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">FloatImage</span><span class="p">(</span><span class="s1">&#39;scenario.png&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">94</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>

            <span class="c1">#draw epicenter</span>
            <span class="k">if</span> <span class="n">edict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#f = folium.map.FeatureGroup(overlay=False)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">color3</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color3</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                    <span class="n">map1</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">(</span>
                                   <span class="p">[</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]],</span>
                                   <span class="n">radius</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                                   <span class="n">color</span><span class="o">=</span><span class="n">color3</span><span class="p">,</span>
                                   <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.5</span>
                                   <span class="p">))</span>

            <span class="k">if</span> <span class="n">savefiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
                    <span class="n">filen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">keyS</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="n">outfilename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mapid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">map1</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">mapid</span>
                <span class="n">map1</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filen</span><span class="p">)</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filen</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removelater</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Make only one layer show up initially</span>
                    <span class="n">removeVis</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="n">removelater</span><span class="p">,</span> <span class="n">map1</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">separate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">separate</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="n">map1</span>

    <span class="k">return</span> <span class="n">maps</span><span class="p">,</span> <span class="n">filenames</span></div>


<div class="viewcode-block" id="GFSummary"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.GFSummary">[docs]</a><span class="k">def</span> <span class="nf">GFSummary</span><span class="p">(</span><span class="n">maplayerlist</span><span class="p">,</span> <span class="n">configs</span><span class="p">,</span> <span class="n">web_template</span><span class="p">,</span> <span class="n">shakemap</span><span class="p">,</span> <span class="n">outfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">includeunc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">faultfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">shakethreshtype</span><span class="o">=</span><span class="s1">&#39;pga&#39;</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pop_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">statlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Max&#39;</span><span class="p">,</span> <span class="s1">&#39;Std&#39;</span><span class="p">,</span> <span class="s1">&#39;Hagg_0.10g&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_pop_0.10g&#39;</span><span class="p">],</span>
              <span class="n">probthresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shakethresh</span><span class="o">=</span><span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span> <span class="n">statement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an interactive html that summarizes all ground failure results for</span>
<span class="sd">    a given earthquake in side-by-side plots and with summary tables</span>

<span class="sd">    Args:</span>
<span class="sd">        maplayerlist (list): list of model output structures to include.</span>
<span class="sd">        configs (list): list of paths to config files corresponding to each</span>
<span class="sd">            of the models in maplayerlist in the same order.</span>
<span class="sd">        web_template (str): Path to location of pelican template</span>
<span class="sd">            (final folder should be &quot;theme&quot;).</span>
<span class="sd">        shakemap (str): path to shakemap .xml file for the current event.</span>
<span class="sd">        outfolder (str, optional): path to folder where output should be</span>
<span class="sd">            placed.</span>
<span class="sd">        includeunc (bool, optional): include uncertainty, NOT IMPLEMENTED.</span>
<span class="sd">        cleanup (bool, optional): clean up all unneeded intermediate files that</span>
<span class="sd">            pelican creates, default True.</span>
<span class="sd">        faultfile (str, optional): GeoJson file of finite fault to display on</span>
<span class="sd">            interactive maps</span>
<span class="sd">        shakethreshtype (str, optional): Type of ground motion to use for stat</span>
<span class="sd">            thresholds, &#39;pga&#39;, &#39;pgv&#39;, or &#39;mmi&#39;</span>
<span class="sd">        point (bool): True if it is known that the ShakeMap used a point</span>
<span class="sd">            source, False does not assume anything about source type.</span>
<span class="sd">        pop_file (str): Path to population file used for statistics</span>
<span class="sd">        statlist (list): list of strings indicating which stats to show on</span>
<span class="sd">            webpage.</span>
<span class="sd">        probthresh (float, optional): List of probability thresholds for which</span>
<span class="sd">            to compute Parea.</span>
<span class="sd">        shakethresh (list, optional): List of ground motion thresholds for</span>
<span class="sd">            which to compute Hagg, units corresponding to shakethreshtype.</span>
<span class="sd">        statement (str): Text to include in the summary section of the web</span>
<span class="sd">            page. Alert statements will be appended prior to this statement,</span>
<span class="sd">            Point source warnings for &gt;M7 will be appended after this</span>
<span class="sd">            statement. If None, will use a generic explanatory statement.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Folder where webpage files are located</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating Ground Failure Summary interactive figure&#39;</span><span class="p">)</span>
    <span class="c1"># get event id</span>
    <span class="n">event_id</span> <span class="o">=</span> <span class="n">maplayerlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">outfolder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">event_id</span><span class="p">)</span>
    <span class="n">fullout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">)</span>
    <span class="n">finalout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="s1">&#39;webpage&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;articles&#39;</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;pages&#39;</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">theme</span> <span class="o">=</span> <span class="n">web_template</span>
    <span class="n">static</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">theme</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullout</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">fullout</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">articles</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">finalout</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">finalout</span><span class="p">)</span>

    <span class="n">peliconf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;pelicanconf.py&#39;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">web_template</span><span class="p">),</span>
                <span class="s1">&#39;pelicanconf.py&#39;</span><span class="p">),</span> <span class="n">peliconf</span><span class="p">)</span>
    <span class="n">outjsfileLS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;mapLS.js&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outjsfileLS</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">outjsfileLQ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;mapLQ.js&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outjsfileLQ</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">statement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;This product provides an early understanding of the &quot;</span>
            <span class="s2">&quot;landslides and liquefaction that may have been triggered &quot;</span>
            <span class="s2">&quot;by this earthquake until first responders and experts &quot;</span>
            <span class="s2">&quot;are able to survey the actual damage that has occurred. &quot;</span>
            <span class="s2">&quot;Results provide regional estimates and &quot;</span>
            <span class="s2">&quot;do not predict specific occurrences.&quot;</span><span class="p">)</span>

    <span class="c1"># Separate the LS and LQ models</span>

    <span class="n">concLS</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">concLQ</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="n">lsmodels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lqmodels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">logLS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">limLS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colLS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logLQ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">limLQ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colLQ</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">il</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iq</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">conf</span><span class="p">,</span> <span class="n">maplayer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="n">maplayerlist</span><span class="p">):</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="c1">#config = ConfigObj(conf)</span>

        <span class="k">if</span> <span class="s1">&#39;landslide&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;modeltype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">plotorder</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="n">colormaps</span><span class="p">,</span> <span class="n">maskthreshes</span> <span class="o">=</span> \
                <span class="n">parseConfigLayers</span><span class="p">(</span><span class="n">maplayer</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
            <span class="n">logLS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logscale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">limLS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">colLS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colormaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">concLS</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;godt&#39;</span> <span class="ow">in</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">statprobthresh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Since logistic models can&#39;t equal one, need to eliminate</span>
                <span class="c1"># placeholder zeros before computing stats</span>
                <span class="n">statprobthresh</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">computeStats</span><span class="p">(</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span>
                                 <span class="n">probthresh</span><span class="o">=</span><span class="n">probthresh</span><span class="p">,</span>
                                 <span class="n">shakefile</span><span class="o">=</span><span class="n">shakemap</span><span class="p">,</span>
                                 <span class="n">shakethresh</span><span class="o">=</span><span class="n">shakethresh</span><span class="p">,</span>
                                 <span class="n">statprobthresh</span><span class="o">=</span><span class="n">statprobthresh</span><span class="p">,</span>
                                 <span class="n">pop_file</span><span class="o">=</span><span class="n">pop_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">il</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">lsmodels</span><span class="p">[</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bin_edges&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stats</span><span class="p">),</span>
                <span class="s1">&#39;layer_on&#39;</span><span class="p">:</span> <span class="n">on</span>
            <span class="p">}</span>
            <span class="n">il</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="s1">&#39;liquefaction&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;modeltype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">plotorder</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="n">colormaps</span><span class="p">,</span> <span class="n">maskthreshes</span> <span class="o">=</span> \
                <span class="n">parseConfigLayers</span><span class="p">(</span><span class="n">maplayer</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
            <span class="n">logLQ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logscale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">limLQ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">colLQ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colormaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">concLQ</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">computeStats</span><span class="p">(</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span>
                                 <span class="n">probthresh</span><span class="o">=</span><span class="n">probthresh</span><span class="p">,</span>
                                 <span class="n">shakefile</span><span class="o">=</span><span class="n">shakemap</span><span class="p">,</span>
                                 <span class="n">shakethresh</span><span class="o">=</span><span class="n">shakethresh</span><span class="p">,</span>
                                 <span class="n">statprobthresh</span><span class="o">=</span><span class="n">statprobthresh</span><span class="p">,</span>
                                 <span class="n">pop_file</span><span class="o">=</span><span class="n">pop_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">lqmodels</span><span class="p">[</span><span class="n">maplayer</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bin_edges&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stats</span><span class="p">),</span>
                <span class="s1">&#39;layer_on&#39;</span><span class="p">:</span> <span class="n">on</span>
            <span class="p">}</span>
            <span class="n">iq</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;model type is undefined, check &quot;</span>
                            <span class="s2">&quot;maplayer[&#39;model&#39;][&#39;parameters&#39;]&quot;</span>
                            <span class="s2">&quot;[&#39;modeltype&#39;] to ensure it is defined&quot;</span><span class="p">)</span>

    <span class="c1"># Make interactive maps for each</span>
    <span class="k">if</span> <span class="n">il</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mapLS</span><span class="p">,</span> <span class="n">filenameLS</span> <span class="o">=</span> <span class="n">interactiveMap</span><span class="p">(</span>
            <span class="n">concLS</span><span class="p">,</span> <span class="n">shakefile</span><span class="o">=</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">scaletype</span><span class="o">=</span><span class="s1">&#39;binned&#39;</span><span class="p">,</span>
            <span class="n">colormaps</span><span class="o">=</span><span class="n">colLS</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="n">limLS</span><span class="p">,</span> <span class="n">clear_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">logscale</span><span class="o">=</span><span class="n">logLS</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outfilename</span><span class="o">=</span><span class="s1">&#39;LS_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event_id</span><span class="p">,</span>
            <span class="n">mapid</span><span class="o">=</span><span class="s1">&#39;LS&#39;</span><span class="p">,</span> <span class="n">savefiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="n">images</span><span class="p">,</span>
            <span class="n">sepcolorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">floatcb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">faultfile</span><span class="o">=</span><span class="n">faultfile</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="s1">&#39;Nowicki Jessee and others (2017)&#39;</span><span class="p">)</span>

        <span class="n">filenameLS</span> <span class="o">=</span> <span class="n">filenameLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filenameLS</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">iq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mapLQ</span><span class="p">,</span> <span class="n">filenameLQ</span> <span class="o">=</span> <span class="n">interactiveMap</span><span class="p">(</span>
            <span class="n">concLQ</span><span class="p">,</span> <span class="n">shakefile</span><span class="o">=</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">scaletype</span><span class="o">=</span><span class="s1">&#39;binned&#39;</span><span class="p">,</span>
            <span class="n">colormaps</span><span class="o">=</span><span class="n">colLQ</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="n">limLQ</span><span class="p">,</span> <span class="n">clear_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">logscale</span><span class="o">=</span><span class="n">logLQ</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outfilename</span><span class="o">=</span><span class="s1">&#39;LQ_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event_id</span><span class="p">,</span>
            <span class="n">savefiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mapid</span><span class="o">=</span><span class="s1">&#39;LQ&#39;</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="n">images</span><span class="p">,</span>
            <span class="n">sepcolorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">floatcb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">faultfile</span><span class="o">=</span><span class="n">faultfile</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="s1">&#39;Zhu and others (2017)&#39;</span><span class="p">)</span>

        <span class="n">filenameLQ</span> <span class="o">=</span> <span class="n">filenameLQ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filenameLQ</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">faultfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">finitefault</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">finitefault</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Try to get urls</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info1</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">get_event_comcat</span><span class="p">(</span><span class="n">shakemap</span><span class="p">)</span>
        <span class="n">eventurl</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">url</span>
        <span class="n">shakemapurl</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;#shakemap&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">shakemapurl</span> <span class="o">=</span> <span class="s1">&#39;https://earthquake.usgs.gov/earthquakes/eventpage/</span><span class="si">%s</span><span class="s1">#shakemap&#39;</span> <span class="o">%</span> <span class="n">event_id</span>
        <span class="n">eventurl</span> <span class="o">=</span> <span class="s1">&#39;https://earthquake.usgs.gov/earthquakes/eventpage/</span><span class="si">%s</span><span class="s1">#executive&#39;</span> <span class="o">%</span> <span class="n">event_id</span>

    <span class="n">write_summary</span><span class="p">(</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">event_url</span><span class="o">=</span><span class="n">eventurl</span><span class="p">,</span>
                  <span class="n">statement</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span> <span class="n">finitefault</span><span class="o">=</span><span class="n">finitefault</span><span class="p">,</span> <span class="n">shake_url</span><span class="o">=</span><span class="n">shakemapurl</span><span class="p">)</span>

    <span class="c1"># Create webpages for each type of ground motion</span>
    <span class="n">write_individual</span><span class="p">(</span><span class="n">lsmodels</span><span class="p">,</span> <span class="n">articles</span><span class="p">,</span> <span class="s1">&#39;Landslides&#39;</span><span class="p">,</span>
                     <span class="n">interactivehtml</span><span class="o">=</span><span class="n">filenameLS</span><span class="p">,</span> <span class="n">outjsfile</span><span class="o">=</span><span class="n">outjsfileLS</span><span class="p">,</span>
                     <span class="n">topimage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statlist</span><span class="o">=</span><span class="n">statlist</span><span class="p">,</span>
                     <span class="n">statement</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">write_individual</span><span class="p">(</span><span class="n">lqmodels</span><span class="p">,</span> <span class="n">articles</span><span class="p">,</span> <span class="s1">&#39;Liquefaction&#39;</span><span class="p">,</span>
                     <span class="n">interactivehtml</span><span class="o">=</span><span class="n">filenameLQ</span><span class="p">,</span> <span class="n">outjsfile</span><span class="o">=</span><span class="n">outjsfileLQ</span><span class="p">,</span>
                     <span class="n">topimage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statlist</span><span class="o">=</span><span class="n">statlist</span><span class="p">,</span>
                     <span class="n">statement</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># run website</span>
    <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">get_command_output</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;pelican -s </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> -t </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">peliconf</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">),</span> <span class="n">theme</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>  <span class="c1"># delete everything except what is needed to make html pages</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">filen</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filen</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filen</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">filen</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filen</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ofiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ofilen</span> <span class="ow">in</span> <span class="n">ofiles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ofilen</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;index.htmlimagestheme&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ofilen</span><span class="p">):</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ofilen</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ofilen</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullout</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">),</span> <span class="n">finalout</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">fullout</span><span class="p">)</span>
        <span class="c1"># Get rid of mapLS.js and mapLQ.js files from theme directory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">theme</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;mapLQ.js&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">theme</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;mapLS.js&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finalout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filenames</span></div>


<div class="viewcode-block" id="write_individual"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.write_individual">[docs]</a><span class="k">def</span> <span class="nf">write_individual</span><span class="p">(</span><span class="n">concatmods</span><span class="p">,</span> <span class="n">outputdir</span><span class="p">,</span> <span class="n">modeltype</span><span class="p">,</span> <span class="n">topimage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">staticmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interactivehtml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">outjsfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write markdown file for landslides or liquefaction.</span>

<span class="sd">    Args:</span>
<span class="sd">        concatmods (float or list): Ordered dictionary of models with</span>
<span class="sd">            fields required for write_individual populated (stats in</span>
<span class="sd">            particular)</span>
<span class="sd">        outputdir (str): Path to output directory.</span>
<span class="sd">        modeltype (str): &#39;Landslides&#39; for landslide model, otherwise it is</span>
<span class="sd">            a liquefaction model.</span>
<span class="sd">        topimage (str, optional): Path to image for top of page.</span>
<span class="sd">        staticmap (str, optional): Path to static map.</span>
<span class="sd">        interactivehtml (str, optional): Path to interactive map file.</span>
<span class="sd">        outjsfile (str, optional): Path for output javascript file.</span>
<span class="sd">        stats (list): List of stats keys to include in the table, if None,</span>
<span class="sd">            it will include all of them</span>

<span class="sd">    Returns:</span>
<span class="sd">        writes markdown files named Landslides.md and/or Liquefaction.md</span>
<span class="sd">        that will be used by GFSummary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">modeltype</span> <span class="o">==</span> <span class="s1">&#39;Landslides&#39;</span><span class="p">:</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="s1">&#39;LS&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="s1">&#39;LQ&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatmods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># If single model and not in list form, turn into lists</span>
        <span class="n">modelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">concatmods</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">stattable</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">stattable</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelnames</span>
        <span class="k">if</span> <span class="n">statlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">statlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">concatmods</span><span class="p">[</span><span class="n">modelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># initialize empty lists for each</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">:</span>
            <span class="n">stattable</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># put stats in</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modelnames</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stattable</span><span class="p">[</span><span class="n">st</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatmods</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="s1">&#39;stats&#39;</span><span class="p">][</span><span class="n">st</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stattable</span><span class="p">[</span><span class="n">st</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">outjsfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outjsfile</span> <span class="o">=</span> <span class="s1">&#39;map.js&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">modeltype</span> <span class="o">+</span> <span class="s1">&#39;.md&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;title: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">modeltype</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;date: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h2&gt;</span><span class="si">%s</span><span class="s1">&lt;/h2&gt;&#39;</span> <span class="o">%</span> <span class="n">modeltype</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatmods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">statement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;</span><span class="si">%s</span><span class="s1">&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">topimage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;images</span><span class="si">%s</span><span class="s1">&quot; width=&quot;250&quot; &#39;</span>
                            <span class="s1">&#39;href=&quot;images</span><span class="si">%s</span><span class="s1">&quot;/&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">topimage</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">topimage</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">interactivehtml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Extract js and move to map.js</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">interactivehtml</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                    <span class="n">soup</span><span class="o">.</span><span class="n">prettify</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">scs</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">scs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">scs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">sc</span><span class="p">):</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                                    <span class="s1">&#39;&lt;script&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&lt;/script&gt;&#39;</span><span class="p">)</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outjsfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
                                    <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="c1"># Embed and link to fullscreen</span>
                <span class="n">fileloc</span> <span class="o">=</span> <span class="n">interactivehtml</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;br&gt;&lt;a href=&quot;images</span><span class="si">%s</span><span class="s1">&quot;&gt;Full &#39;</span>
                            <span class="s1">&#39;interactive map&lt;/a&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="n">fileloc</span><span class="p">)</span>

                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;center&gt;&lt;div class=&quot;folium-map&quot; id=&quot;map_</span><span class="si">%s</span><span class="s1">&quot;&gt;&#39;</span>
                            <span class="s1">&#39;&lt;/div&gt;&lt;/center&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">id1</span><span class="p">)</span>

                <span class="n">cbname</span> <span class="o">=</span> <span class="n">fileloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.html&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_colorbar&#39;</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;center&gt;&lt;img src=&quot;images</span><span class="si">%s</span><span class="s1">&quot; width=&quot;410&quot; &#39;</span>
                            <span class="s1">&#39;href=&quot;images</span><span class="si">%s</span><span class="s1">&quot;/&gt;&lt;/center&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">cbname</span><span class="p">,</span> <span class="n">cbname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">staticmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;center&gt;&lt;img src=&quot;images</span><span class="si">%s</span><span class="s1">&quot; width=&quot;450&quot; &#39;</span>
                                <span class="s1">&#39;href=&quot;images</span><span class="si">%s</span><span class="s1">&quot;/&gt;&lt;/center&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">staticmap</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">staticmap</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;hr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h3&gt;</span><span class="si">%s</span><span class="s1"> Model Summary Statistics&lt;/h3&gt;&#39;</span> <span class="o">%</span>
                            <span class="n">modeltype</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;table style=&quot;width:100%&quot;&gt;&#39;</span><span class="p">)</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;th&gt;Model&lt;/th&gt;&#39;</span><span class="p">)</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;th&gt;Output Type&lt;/th&gt;&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">:</span>
                    <span class="c1"># if &#39;Hagg_&#39; in st:</span>
                    <span class="c1">#    thresh = float(st.split(&#39;_&#39;)[-1].replace(&#39;g&#39;,&#39;&#39;))</span>
                    <span class="c1">#    titl = &#39;Aggregate Hazard (km^2)&#39; % (100.*thresh,)</span>
                    <span class="k">if</span> <span class="s1">&#39;Hagg&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                        <span class="n">titl</span> <span class="o">=</span> <span class="s1">&#39;Aggregate Hazard (km^2)&#39;</span>
                    <span class="c1"># elif &#39;exp_pop_&#39; in st:</span>
                    <span class="c1">#    thresh = float(st.split(&#39;_&#39;)[-1].replace(&#39;g&#39;,&#39;&#39;))</span>
                    <span class="c1">#    titl = &#39;People at risk (&gt;%2.0f g)&#39; % (100.*thresh,)</span>
                    <span class="k">elif</span> <span class="s1">&#39;exp_pop&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                        <span class="n">titl</span> <span class="o">=</span> <span class="s1">&#39;Population Exposure&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;Max&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                        <span class="n">titl</span> <span class="o">=</span> <span class="s1">&#39;Maximum probability&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;Std&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                        <span class="n">titl</span> <span class="o">=</span> <span class="s1">&#39;Standard deviation&#39;</span>

                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;th&gt;</span><span class="si">%s</span><span class="s1">&lt;/th&gt;&#39;</span> <span class="o">%</span> <span class="n">titl</span><span class="p">)</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Write each row</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modelnames</span><span class="p">):</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">)</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span> <span class="o">%</span> <span class="n">mod</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
                    <span class="c1"># Get output type</span>
                    <span class="k">if</span> <span class="s1">&#39;2014&#39;</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">:</span>
                        <span class="n">type1</span> <span class="o">=</span> <span class="s1">&#39;Probability of any occurrence in cell&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">type1</span> <span class="o">=</span> <span class="s1">&#39;Proportion of area affected&#39;</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&#39;</span> <span class="o">%</span> <span class="n">type1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;hagg&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;parea&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%1.0f</span><span class="s1">&lt;/td&gt;&#39;</span> <span class="o">%</span> <span class="n">stattable</span><span class="p">[</span><span class="n">st</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">%1.2f</span><span class="s1">&lt;/td&gt;&#39;</span> <span class="o">%</span> <span class="n">stattable</span><span class="p">[</span><span class="n">st</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h3&gt;No results&lt;/h3&gt;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_summary"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.write_summary">[docs]</a><span class="k">def</span> <span class="nf">write_summary</span><span class="p">(</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">outputdir</span><span class="p">,</span> <span class="n">imgoutputdir</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">finitefault</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">event_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">shake_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write markdown file summarizing event</span>

<span class="sd">    Args:</span>
<span class="sd">        shakemap (str): path to shakemap .xml file for the current event</span>
<span class="sd">        outputdir (str): path to folder where output should be placed</span>
<span class="sd">        imgoutputdir (str): path to folder where images should be placed</span>
<span class="sd">            and linked</span>
<span class="sd">        statement (str): Statement to put at top of GFSummary plot, if None</span>
<span class="sd">            will append some generic statements.</span>
<span class="sd">        finitefault (bool): True if it is known that the shakemap used a</span>
<span class="sd">            finite fault.</span>
<span class="sd">        point(bool): True if it is known that the event was a point</span>
<span class="sd">            source. False if unknown.</span>
<span class="sd">        event_url (str): url to event page, if None, code will try to</span>
<span class="sd">            guess what the url should be using the event_id in the shakemap file</span>
<span class="sd">        shake_url (str): url to shakemap page for this event, if None,</span>
<span class="sd">            code will try to guess what the url should be using the</span>
<span class="sd">            event_id in the shakemap file</span>

<span class="sd">    Returns:</span>
<span class="sd">        Markdown file that summarizes the event and model used by GFSummary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getEventDict</span><span class="p">()</span>
    <span class="n">smdict</span> <span class="o">=</span> <span class="n">ShakeGrid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shakemap</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getShakeDict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">event_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">event_url</span> <span class="o">=</span> <span class="s1">&#39;https://earthquake.usgs.gov/earthquakes/eventpage/</span><span class="si">%s</span><span class="s1">#executive&#39;</span> <span class="o">%</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shake_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shake_url</span> <span class="o">=</span> <span class="n">event_url</span> <span class="o">+</span> <span class="s1">&#39;#shakemap&#39;</span>

    <span class="k">if</span> <span class="n">finitefault</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">point</span><span class="p">:</span>
        <span class="n">faulttype</span> <span class="o">=</span> <span class="s1">&#39;(finite fault model)&#39;</span>
    <span class="k">elif</span> <span class="n">point</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">finitefault</span><span class="p">:</span>
        <span class="n">faulttype</span> <span class="o">=</span> <span class="s1">&#39;(point source model)&#39;</span>
        <span class="k">if</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">6.5</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&lt;br&gt;ShakeMap is currently approximating &#39;</span>
                         <span class="s1">&#39;this earthquake as a point source. &#39;</span>
                         <span class="s1">&#39;This may underestimate the extent of strong &#39;</span>
                         <span class="s1">&#39;shaking for larger earthquakes. &#39;</span>
                         <span class="s1">&#39;Please interpret Ground Failure results with &#39;</span>
                         <span class="s1">&#39;caution until ShakeMap has been updated &#39;</span>
                         <span class="s1">&#39;with a fault model.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">statement</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">faulttype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s1">&#39;Summary.md&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;title: summary</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;date: 2017-06-09</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;modified: 2017-06-09</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h1 align=&quot;left&quot;&gt;Ground Failure&lt;/h1&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;scenario&#39;</span> <span class="ow">in</span> <span class="n">smdict</span><span class="p">[</span><span class="s1">&#39;shakemap_event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h2 align=&quot;left&quot;&gt;&lt;a href=</span><span class="si">%s</span><span class="s1">&gt;Magnitude </span><span class="si">%1.1f</span><span class="s1"> Scenario Earthquake - </span><span class="si">%s</span><span class="s1">&lt;/a&gt;&lt;/h2&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">event_url</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                           <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h2 align=&quot;left&quot;&gt;&lt;a href=</span><span class="si">%s</span><span class="s1">&gt;Magnitude </span><span class="si">%1.1f</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&lt;/a&gt;&lt;/h2&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">event_url</span><span class="p">,</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                           <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">]))</span>

        <span class="n">writeline</span> <span class="o">=</span> <span class="s1">&#39;&lt;h3 align=&quot;left&quot;&gt; </span><span class="si">%s</span><span class="s1"> (UTC) | </span><span class="si">%1.4f</span><span class="s1">&amp;#176,  </span><span class="si">%1.4f</span><span class="s1">&amp;#176 | </span><span class="si">%1.1f</span><span class="s1"> km depth&lt;/h3&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">),</span>
                        <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writeline</span><span class="p">)</span>

        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p align=&quot;left&quot;&gt;Last updated at: </span><span class="si">%s</span><span class="s1"> (UTC)&lt;br&gt;&#39;</span>
                    <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Based on ground motion estimates from &#39;</span>
                    <span class="s1">&#39;&lt;a href=</span><span class="si">%s</span><span class="s1">&gt;ShakeMap&lt;/a&gt; version </span><span class="si">%1.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&lt;br&gt;&lt;/p&gt;&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">shake_url</span><span class="p">,</span> <span class="n">smdict</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">],</span> <span class="n">faulttype</span><span class="p">))</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&lt;br&gt;Refer to the &lt;a https://earthquake.usgs.gov/data/&#39;</span>
                     <span class="s1">&#39;ground-failure/background.php&gt;Ground Failure Background&lt;/a&gt;&#39;</span>
                     <span class="s1">&#39; page for more details.&#39;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">statement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h2 align=&quot;left&quot;&gt;Summary&lt;/h2&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p align=&quot;left&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span>

        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;hr&gt;&#39;</span><span class="p">)</span>

    <span class="n">shakesummary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;shakemap_version&#39;</span><span class="p">:</span> <span class="n">smdict</span><span class="p">[</span><span class="s1">&#39;shakemap_version&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Magnitude </span><span class="si">%1.1f</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">edict</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">],</span>
                                                      <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_description&#39;</span><span class="p">]),</span>
                    <span class="s1">&#39;statement&#39;</span><span class="p">:</span> <span class="n">statement</span><span class="p">,</span>
                    <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="n">edict</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;shakemap_id&#39;</span><span class="p">:</span> <span class="n">smdict</span><span class="p">[</span><span class="s1">&#39;shakemap_id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;event_url&#39;</span><span class="p">:</span> <span class="n">event_url</span>
                    <span class="p">}</span>

    <span class="k">return</span> <span class="n">shakesummary</span></div>


<div class="viewcode-block" id="setupsync"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.setupsync">[docs]</a><span class="k">def</span> <span class="nf">setupsync</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">plotorder</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="n">colormaps</span><span class="p">,</span> <span class="n">defaultcolormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">CMRmap_r</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get colors that will be used for all colorbars from reference grid</span>

<span class="sd">    Args:</span>
<span class="sd">        sync(str): If False, will exit program, else corresponds to the shortref</span>
<span class="sd">            of the model which should serve as the template for</span>
<span class="sd">            the colorbars used by all other models. All other models must</span>
<span class="sd">            have the exact same number of bins</span>
<span class="sd">        plotorder (list): List of keys of shortrefs of the grids that will be</span>
<span class="sd">            plotted.</span>
<span class="sd">        lims (*): Nx1 list of tuples or numpy arrays corresponding to</span>
<span class="sd">            plotorder defining the bin edges to use for each model.</span>
<span class="sd">            Example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                [(0., 0.1, 0.2, 0.3), np.linspace(0., 1.5, 15)]</span>

<span class="sd">        colormaps (list): List of strings of matplotlib colormaps (e.g.</span>
<span class="sd">            cm.autumn_r) corresponding to plotorder</span>
<span class="sd">        defaultcolormap (matplotlib colormap): Colormap to use if</span>
<span class="sd">            colormaps is not defined. default cm.CMRmap_r</span>
<span class="sd">        logscale (*): If not None, then a list of booleans corresponding to</span>
<span class="sd">            plotorder stating whether to use log scaling in determining colors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (sync, colorlist, lim1) where:</span>
<span class="sd">            * sync (bool): whether or not colorbars are/can be synced</span>
<span class="sd">            * colorlist (list): list of rgba colors that will be applied to all</span>
<span class="sd">                models regardless of bin edge values</span>
<span class="sd">            * lim1 (array): bin edges of model to which others are synced</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sync</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">sync</span> <span class="ow">in</span> <span class="n">plotorder</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="n">indx</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotorder</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sync</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Make sure lims exist and all have the same number of bins&#39;</span>

        <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="n">logscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">lim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">sum1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lim</span> <span class="ow">in</span> <span class="n">lims</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sum1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lim1</span><span class="p">):</span>
                <span class="n">sum1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sum1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot sync colorbars, different number of bins or lims not specified&#39;</span><span class="p">)</span>
            <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">sync</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">palette1</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">palette1</span> <span class="o">=</span> <span class="n">defaultcolormap</span>
        <span class="c1">#palette1.set_bad(clear_color, alpha=0.0)</span>
        <span class="k">if</span> <span class="n">logs</span><span class="p">:</span>
            <span class="n">cNorm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">midpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lim1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># geometric mean for midpoints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cNorm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">midpts</span> <span class="o">=</span> <span class="p">(</span><span class="n">lim1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lim1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette1</span><span class="p">)</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">midpts</span><span class="p">:</span>
            <span class="n">colorlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot sync colorbars, different number of bins or lims not specified&#39;</span><span class="p">)</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lim1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">sync</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">,</span> <span class="n">lim1</span></div>


<div class="viewcode-block" id="correct4colorbar"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.correct4colorbar">[docs]</a><span class="k">def</span> <span class="nf">correct4colorbar</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">gridlims</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">scaletype</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">colorlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create rgba layer for plotting along with all the info needed to create</span>
<span class="sd">    a separate colorbar</span>

<span class="sd">    Args:</span>
<span class="sd">        dat (array): 2D numpy array of the data to turn into rgba layer</span>
<span class="sd">        gridlims (array): Nx1 array or list of bin edges, or None if not specified</span>
<span class="sd">        logscale (bool): if True, will use log scaling for bins</span>
<span class="sd">        scaletype (str): Type of scaling to use with colormap,</span>
<span class="sd">            &#39;binned&#39; or &#39;continuous.&#39; &#39;binned&#39; must be used for synced</span>
<span class="sd">            colorbars.</span>
<span class="sd">        palette: colormap palette to use</span>
<span class="sd">        colorlist (list): Optional, N-1 list of colors to use for each bin,</span>
<span class="sd">            where N is the number of bin edges specified in gridlims. Only</span>
<span class="sd">            works if scaletype = &#39;binned&#39;</span>
<span class="sd">        alpha (float): Transparency value from 0 to 1</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (clev, vmin, vmax, rgba_img, cmap, norm, colorlist) where:</span>
<span class="sd">            * clev: bin edges used</span>
<span class="sd">            * vmin: lowest bin edge (saturated below)</span>
<span class="sd">            * vmax: highest bin edge (saturated above)</span>
<span class="sd">            * rgba_img: rgba image (2D array of rgba tuples)</span>
<span class="sd">            * cmap: colormap used</span>
<span class="sd">            * norm: normalization used for colorbar</span>
<span class="sd">            * colorlist: list of colors used for each colorbar bin,</span>
<span class="sd">                None if scaletype was &#39;continuous&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">minnonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minnonzero</span> <span class="o">=</span> <span class="mf">0.0001</span>

    <span class="k">if</span> <span class="n">scaletype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binned&#39;</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">))</span>
        <span class="n">datcop</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">colorlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clev</span> <span class="o">=</span> <span class="n">gridlims</span>
            <span class="n">datcop</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">gridlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gridlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">datcop</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">gridlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gridlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colorlist</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">clev</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="n">datcop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datcop</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datcop</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">palette</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">clev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">)),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span> <span class="mi">2</span><span class="o">*</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span> <span class="o">&gt;=</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># geometric mean</span>
                <span class="c1"># So colorbar saturates at top</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">midpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># geometric mean for midpoints</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gridlims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">order</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scal</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">minnonzero</span><span class="p">),</span>
                                            <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">minnonzero</span><span class="p">),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)),</span>
                                            <span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="n">scal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="n">gridlims</span>
                    <span class="c1"># Adjust uppermost clev to make the best use of the colorbar</span>
                    <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">dat</span><span class="p">[(</span><span class="n">dat</span> <span class="o">&gt;=</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">clev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                <span class="c1"># So colorbar saturates at top</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">midpts</span> <span class="o">=</span> <span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">clev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span>  <span class="c1"># Normalize by vmin and vmax so colorbar matches</span>
            <span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">dat1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="c1"># make colorlist</span>
            <span class="n">colorlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">midpts</span><span class="p">:</span>
                <span class="n">colorlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">colorlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gridlims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">))</span>
                <span class="n">clev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">)),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">))),</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">clev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">gridlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">))</span>
                <span class="n">clev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">minnonzero</span><span class="p">)),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">gridlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">clev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">gridlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">gridlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">clev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>  <span class="c1"># saturate at ends</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">palette</span>
        <span class="n">dat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span>  <span class="c1"># Normalize by vmin and vmax so colorbar matches</span>
        <span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">rgba_img</span> <span class="o">=</span> <span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">dat1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clev</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">rgba_img</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">colorlist</span></div>


<div class="viewcode-block" id="make_hillshade"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.make_hillshade">[docs]</a><span class="k">def</span> <span class="nf">make_hillshade</span><span class="p">(</span><span class="n">topogrid</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="mf">315.</span><span class="p">,</span> <span class="n">angle_altitude</span><span class="o">=</span><span class="mf">50.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a hillshade from a digital elevation model.</span>
<span class="sd">    Adapted from</span>
<span class="sd">    &lt;http://geoexamples.blogspot.com/2014/03/shaded-relief-images-using-gdal-python.html&gt;</span>
<span class="sd">    last accessed 9/2/2015</span>

<span class="sd">    Args:</span>
<span class="sd">        topogrid (Grid2D): Digital elevation model.</span>
<span class="sd">        azimuth (float): Azimuth of illumination in degrees.</span>
<span class="sd">        angle_altitude (float): Altitude angle of illumination.</span>

<span class="sd">    Returns: Hillshade map layer (Grid2D object).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">topotmp</span> <span class="o">=</span> <span class="n">topogrid</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># make a masked array</span>
    <span class="n">topotmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">topotmp</span><span class="p">)</span>
    <span class="n">topodat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">topotmp</span><span class="p">),</span> <span class="n">topotmp</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">topodat</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">))</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">azimuthrad</span> <span class="o">=</span> <span class="n">azimuth</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
    <span class="n">altituderad</span> <span class="o">=</span> <span class="n">angle_altitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
    <span class="n">shaded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altituderad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altituderad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuthrad</span> <span class="o">-</span> <span class="n">aspect</span><span class="p">)</span>
    <span class="n">hillshade</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">topogrid</span><span class="p">)</span>
    <span class="n">hillshade</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">shaded</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hillshade</span></div>


<div class="viewcode-block" id="getMapLines"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.getMapLines">[docs]</a><span class="k">def</span> <span class="nf">getMapLines</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">nlines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get equally spaced lat or lon lines for mapping</span>

<span class="sd">    Args:</span>
<span class="sd">        dmin (float): minimum lat or lon</span>
<span class="sd">        dmax (float): maximum lat or lon</span>
<span class="sd">        nlines (int): number of lines</span>

<span class="sd">    Returns:</span>
<span class="sd">        array: location of lines</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">drange</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">-</span><span class="n">dmin</span>
    <span class="k">if</span> <span class="n">drange</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">near</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">drange</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">near</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">near</span> <span class="o">=</span> <span class="mf">0.125</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="n">roundToNearest</span><span class="p">(</span><span class="n">drange</span><span class="o">/</span><span class="n">nlines</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># make the increment the closest power of 10</span>
        <span class="n">near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">drange</span><span class="p">)))</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">drange</span><span class="o">/</span><span class="n">nlines</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmin</span> <span class="o">=</span> <span class="n">floorToNearest</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmax</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newdmin</span> <span class="o">=</span> <span class="n">ceilToNearest</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
        <span class="n">newdmax</span> <span class="o">=</span> <span class="n">floorToNearest</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="n">near</span><span class="p">)</span>
    <span class="n">darray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">newdmin</span><span class="p">,</span> <span class="n">newdmax</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">darray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
        <span class="n">darray</span> <span class="o">=</span> <span class="n">darray</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">darray</span></div>


<div class="viewcode-block" id="getProjectedPatch"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.getProjectedPatch">[docs]</a><span class="k">def</span> <span class="nf">getProjectedPatch</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">edgecolor</span><span class="p">,</span> <span class="n">facecolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project a polygon to coordinate system used in Basemap m</span>

<span class="sd">    Args:</span>
<span class="sd">        polygon: list of shapely polygons to project</span>
<span class="sd">        m: Basemap map to project polygon to</span>
<span class="sd">        edgecolor: color to use for polygon edge</span>
<span class="sd">        facecolor: color to use to fill polygon</span>
<span class="sd">        lw: line width for edge of polygon</span>
<span class="sd">        zorder: plotting order of polygons</span>

<span class="sd">    Returns:</span>
<span class="sd">        patch: patch of projected polygons that can be added to map figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">polyjson</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="n">tlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">polyjson</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sequence</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
    <span class="n">polyjson</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tlist</span><span class="p">)</span>
    <span class="n">ppolygon</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">polyjson</span><span class="p">)</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="n">ppolygon</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">patch</span></div>


<div class="viewcode-block" id="roundToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.roundToNearest">[docs]</a><span class="k">def</span> <span class="nf">roundToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">roundValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, rounded to nearest roundValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be rounded.</span>
<span class="sd">        roundValue (float): Number to which the value should be rounded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Rounded value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">roundValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">roundValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">roundValue</span> <span class="o">=</span> <span class="n">roundValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">roundValue</span><span class="p">)</span><span class="o">*</span><span class="n">roundValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">roundValue</span><span class="p">)</span><span class="o">*</span><span class="n">roundValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="floorToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.floorToNearest">[docs]</a><span class="k">def</span> <span class="nf">floorToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">floorValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, floored to nearest floorValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be floored.</span>
<span class="sd">        floorValue (float): Number to which the value should be floored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Floored value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">floorValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">floorValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">floorValue</span> <span class="o">=</span> <span class="n">floorValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">floorValue</span><span class="p">)</span><span class="o">*</span><span class="n">floorValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">floorValue</span><span class="p">)</span><span class="o">*</span><span class="n">floorValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="ceilToNearest"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.ceilToNearest">[docs]</a><span class="k">def</span> <span class="nf">ceilToNearest</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ceilValue</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value, ceiled to nearest ceilValue (defaults to 1000).</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): Value to be ceiled.</span>
<span class="sd">        ceilValue (float): Number to which the value should be ceiled.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Ceiling-ed value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ceilValue</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ceilValue</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">ceilValue</span> <span class="o">=</span> <span class="n">ceilValue</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">ceilValue</span><span class="p">)</span><span class="o">*</span><span class="n">ceilValue</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">nd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="n">ceilValue</span><span class="p">)</span><span class="o">*</span><span class="n">ceilValue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="removeVis"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.removeVis">[docs]</a><span class="k">def</span> <span class="nf">removeVis</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">removelater</span><span class="p">,</span> <span class="n">mapname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes some baselayers from initial visibility in Leaflet map.</span>
<span class="sd">    This fixes a minor bug in folium where all baselayers are active</span>
<span class="sd">    initially because you have to add a layer to the map for it to</span>
<span class="sd">    show up at all in folium, but for it to start as invisible in</span>
<span class="sd">    Leaflet, you have to add it only to layer control, not to the map.</span>
<span class="sd">    In folium, layer control inherits directly from the layers added to map.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (text): Name of html file to remove layer visibility</span>
<span class="sd">        removelater (list): List of element names to remove visibility</span>
<span class="sd">            from initial plot</span>

<span class="sd">    Returns:</span>
<span class="sd">        filename modified so that removelater layers will be invisible</span>
<span class="sd">            initially</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">replacetext</span> <span class="o">=</span> <span class="s1">&#39;.addTo(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">mapname</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">newlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">remove</span> <span class="ow">in</span> <span class="n">removelater</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="s1">&#39;var </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remove</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">r1</span> <span class="ow">and</span> <span class="n">replacetext</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">newline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replacetext</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">newlines</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">newlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="getZoom"><a class="viewcode-back" href="../../gfail.makemaps.html#gfail.makemaps.getZoom">[docs]</a><span class="k">def</span> <span class="nf">getZoom</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the best starting zoom level based on span of coordinates</span>

<span class="sd">    Args:</span>
<span class="sd">        minlon (float): minimum longitude in area of interest</span>
<span class="sd">        maxlon (float): maximum longitude in area of interest</span>

<span class="sd">    Returns:</span>
<span class="sd">        zoom level (for leaflet)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">maxlon</span> <span class="o">-</span> <span class="n">minlon</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">+=</span> <span class="mi">360</span>
    <span class="n">zoom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="mi">360</span><span class="o">/</span><span class="n">angle</span><span class="o">/</span><span class="mi">256</span><span class="o">/</span><span class="mf">0.693</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">zoom</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">groundfailure</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gfail.html">gfail</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>